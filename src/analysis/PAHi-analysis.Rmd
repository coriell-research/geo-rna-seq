---
title: "PAHi Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in `SummarizedExperiment` data

```{r}
suppressPackageStartupMessages(library(SummarizedExperiment))
library(here)


dge_se <- readRDS(here("results", "combined", "rds-files", "dge_se.rds"))
dre_se <- readRDS(here("results", "combined", "rds-files", "dre_se.rds"))
```

## Subset for only PAHi data

```{r}
pahi_dge <- dge_se[, dge_se$epigenetic_class == "PAHi"]
pahi_dre <- dre_se[, dre_se$epigenetic_class == "PAHi"]
```

## Perform PCA

```{r}
library(PCAtools)


pca.dge <- pca(
  mat = assay(pahi_dge, "lfc"),
  metadata = as.data.frame(colData(pahi_dge)),
  center = TRUE,
  scale = FALSE,
  removeVar = 0.25
)

pca.dre <- pca(
  mat = assay(pahi_dre, "lfc"),
  metadata = as.data.frame(colData(pahi_dre)),
  center = TRUE,
  scale = FALSE,
  removeVar = 0.25
)
```

## Visualize PCA biplot

```{r}
library(patchwork)


# Gene Expression
gene_biplot <- biplot(
  pca.dge, 
  colby = "tissue", 
  lab = pca.dge$metadata$drug,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Protein Coding Gene Expression",
  subtitle = "Colored by tissue, labelled by drug"
  )

# Repetitive Elements
re_biplot <- biplot(
  pca.dre, 
  colby = "tissue", 
  lab = pca.dre$metadata$drug,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Repetitive Element Expression",
  subtitle = "Colored by tissue, labelled by drug"
  )

# Create patchwork
(gene_biplot | re_biplot) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "PAHi Drugs") & 
  theme(legend.position = "bottom", 
        title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "biplot.png"), width = 18, height = 12)

# REMOVE LABELS ---
# Gene Expression
gene_biplot2 <- biplot(
  pca.dge, 
  colby = "tissue", 
  lab = NULL,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Protein Coding Gene Expression",
  subtitle = "Colored by tissue"
  )

# Repetitive Elements
re_biplot2 <- biplot(
  pca.dre, 
  colby = "tissue", 
  lab = NULL,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Repetitive Element Expression",
  subtitle = "Colored by tissue"
  )

# Create patchwork
(gene_biplot2 | re_biplot2) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "PAHi Drugs") & 
  theme(legend.position = "bottom", 
        title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "biplot-noLab.png"), width = 18, height = 12)

# Color by TISSUE TYPE
# Gene Expression
gene_biplot3 <- biplot(
  pca.dge, 
  colby = "experiment", 
  lab = pca.dge$metadata$cell_line,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Protein Coding Gene Expression",
  subtitle = "Colored by experiment, labelled by cell line"
  )

# Repetitive Elements
re_biplot3 <- biplot(
  pca.dre, 
  colby = "experiment", 
  lab = pca.dre$metadata$cell_line,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Repetitive Element Expression",
  subtitle = "Colored by experiment, labelled by cell line"
  )

# Create patchwork
(gene_biplot3 | re_biplot3) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "PAHi Drugs") & 
  theme(legend.position = "bottom", 
        title = element_text(size = 18, face = "bold"))
ggsave(here("results", "pahi", "figures", "biplot-byCellLine.png"), width = 18, height = 12)

# No labels
# Gene Expression
gene_biplot4 <- biplot(
  pca.dge, 
  colby = "experiment", 
  lab = NULL,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Protein Coding Gene Expression",
  subtitle = "Colored by experiment"
  )

# Repetitive Elements
re_biplot4 <- biplot(
  pca.dre, 
  colby = "experiment", 
  lab = NULL,
  pointSize = 5,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Repetitive Element Expression",
  subtitle = "Colored by experiment"
  )

# Create patchwork
(gene_biplot4 | re_biplot4) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "PAHi Drugs") & 
  theme(legend.position = "bottom", 
        title = element_text(size = 18, face = "bold"))
ggsave(here("results", "pahi", "figures", "biplot-byCellLine-noLab.png"), width = 18, height = 12)
```

### Loadings plot

```{r}
lp1 <- plotloadings(pca.dge, title = "Protein Coding Genes", rangeRetain = 0.01, labSize = 3)
lp2 <- plotloadings(pca.dre, title = "Repetitive Elements", rangeRetain = 0.01, labSize = 2)

(lp1 | lp2) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "PAHi Drugs Loadings") &
  theme(legend.position = "bottom", plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "loadings.png"), width = 18, height = 11)
```

## Get pahi experiment breakdown

```{r}
length(unique(colData(pahi_dge)$disease))
```

---

## Meta Analysis on PAHi

```{r}
library(data.table)


dge_dt <- fread(here("results", "combined", "data-files", "dge-all-experiments.csv.gz"))
dre_dt <- fread(here("results", "combined", "data-files", "dre-all-experiments.csv.gz"))
```

```{r}
library(coriell)
library(ggrepel)


pahi_dge_dt <- dge_dt[id %chin% colnames(assay(pahi_dge, "lfc"))]
pahi_dre_dt <- dre_dt[id %chin% colnames(assay(pahi_dre, "lfc"))]
dge_list <- split(pahi_dge_dt, by = "id")
dre_list <- split(pahi_dre_dt, by = "id")

# ---
# vote counting meta analysis
dge_meta_vote <- meta_vote(
  exp_list = dge_list,
  pval = 0.1,
  meta_prop = 0.5
)

dre_meta_vote <- meta_vote(
  exp_list = dre_list,
  pval = 0.1,
  meta_prop = 0.5
)

# p-value combination
dge_meta_pcomb <- meta_pcombine(
  exp_list = dge_list,
  method = "fisher",
  na.rm = TRUE
)

# p-value combination
dre_meta_pcomb <- meta_pcombine(
  exp_list = dre_list,
  method = "fisher",
  na.rm = TRUE
)
```

create plots

```{r}
# meta volcano plots
plot_metavolcano(dge_meta_vote) +
  geom_text_repel(data = dge_meta_vote[vote != "unperturbed"], max.overlaps = 25, size = 4) +
  annotate("label", x = -45, y = 20, label = "64") +
  annotate("label", x = 45, y = 20, label = "70") +
  labs(title = "PAHi Protein Coding Genes - Meta-Vote Counting")
ggsave(here("results", "pahi", "figures", "gene-metaVote.png"), width = 11, height = 7)

plot_metavolcano(dre_meta_vote) +
  geom_text_repel(data = dre_meta_vote[vote != "unperturbed"], size = 4) +
  labs(title = "PAHi Repetitive Elements - Meta-Vote Counting")
ggsave(here("results", "pahi", "figures", "re-metaVote.png"), width = 11, height = 7)

# meta p-value plots
plot_volcano(dge_meta_pcomb, x = meta_lfc, y = meta_p, fdr = 0.01, lfc = log2(2)) +
  labs(title = "PAHi Protein Coding Genes - Meta-PCombine",
       x = "mean logFC",
       y = "-log10(meta P-value)")
ggsave(here("results", "pahi", "figures", "gene-metaPcomb.png"), width = 11, height = 7)

plot_volcano(dre_meta_pcomb, x = meta_lfc, y = meta_p, fdr = 0.01, lfc = log2(2), label_sig = TRUE) +
  labs(title = "PAHi Repetitive Elements - Meta-PCombine",
       x = "mean logFC",
       y = "-log10(meta P-value)")
ggsave(here("results", "pahi", "figures", "re-metaPcomb.png"), width = 11, height = 7)
```

## How much do these sets overlap?

```{r}
library(ComplexHeatmap)


dge_vote_up <- dge_meta_vote[vote == "up", feature_id]
dge_vote_down <- dge_meta_vote[vote == "down", feature_id]
dge_pcomb_up <- dge_meta_pcomb[meta_lfc > 1 & meta_p < 0.01, feature_id]
dge_pcomb_down <- dge_meta_pcomb[meta_lfc < -1 & meta_p < 0.01, feature_id]
l <- list("vote - up" = dge_vote_up, "vote - down" = dge_vote_down,
          "pComb - up" = dge_pcomb_up, "pComb - down" = dge_pcomb_down)
m <- make_comb_mat(list_to_matrix(l), mode = "intersect")

png(here("results", "pahi", "figures", "upset.png"), width = 11, height = 7, units = "in", res = 200)
UpSet(
  m, 
  comb_order = order(comb_size(m)),
  top_annotation = upset_top_annotation(m, add_numbers = TRUE),
  right_annotation = upset_right_annotation(m, add_numbers = TRUE)
  )
dev.off()
```

## GO on the up/down genes

```{r}
up_intersect <- intersect(dge_vote_up, dge_pcomb_up)
down_intersect <- intersect(dge_vote_down, dge_pcomb_down)
go_up <- panther_go(up_intersect, organism = "9606", annot_dataset = "biological_process")
go_down <- panther_go(down_intersect, organism = "9606", annot_dataset = "biological_process")
```

```{r}
library(gridExtra)


up_tbl <- go_up$table[, term := as.character(unlist(term))][!term %like% "^GO"][order(pValue)][1:10]
png(here("results", "pahi", "figures", "GO-up-table.png"), height = 50 * nrow(up_tbl), width = 150 * ncol(up_tbl))
grid.table(up_tbl, rows = NULL)
dev.off()
```


```{r}
down_tbl <- go_down$table[, term := as.character(unlist(term))][!term %like% "^GO"][order(pValue)][1:10]
png(here("results", "pahi", "figures", "GO-down-table.png"), height = 50 * nrow(down_tbl), width = 150 * ncol(down_tbl))
grid.table(down_tbl, rows = NULL)
dev.off()
```

## Correlate Gene Expression with RE Expression

```{r}
library(psych)


lfc_mat <- rbind(assay(pahi_dge, "lfc"), assay(pahi_dre, "lfc"))
corr <- corr.test(t(lfc_mat), ci = FALSE, method = "spearman", adjust = "holm")
cor_pValues <- as.data.table(corr$p, keep.rownames = "feature_id")
cor_rValues <- as.data.table(corr$r, keep.rownames = "feature_id")
cor_pValues.m <- melt(
  cor_pValues, 
  id.vars = "feature_id", 
  variable.name = "feature_id2", 
  value.name = "pValue", 
  variable.factor = FALSE
  )
cor_rValues.m <- melt(
  cor_rValues, 
  id.vars = "feature_id", 
  variable.name = "feature_id2", 
  value.name = "r",
  variable.factor = FALSE
  )
cor_dt <- cbind(cor_pValues.m, cor_rValues.m[, .(r)])
cor_dt <- cor_dt[feature_id != feature_id2]
```

What do the up/down consensus genes correlate with?

```{r}
sig_cors_cons <- cor_dt[pValue < 0.05 & 
       feature_id %chin% rownames(assay(pahi_dge, "lfc")) & 
       feature_id2 %chin% rownames(assay(pahi_dre, "lfc")) & 
       feature_id %chin% union(up_intersect, down_intersect)]

ggplot(sig_cors_cons, aes(x = feature_id, y = feature_id2, size = -log10(pValue), color = r)) +
  geom_point() +
  scale_color_viridis_c() +
  labs(title = "Consensus Gene Significant (p < 0.05) Correlations with REs",
       x = "Protein Coding Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(here("results", "pahi", "figures", "sigGeneRE-correlations.png"), width = 11, height = 7)

# Examine Correlations by Family ---
cors_cons <- cor_dt[
  feature_id %chin% rownames(assay(pahi_dge, "lfc")) & 
  feature_id2 %chin% rownames(assay(pahi_dre, "lfc")) & 
  feature_id %chin% union(up_intersect, down_intersect)]

# Fisher Method for combining pValues
meta_fisher <- function(x) {
  test_stat <- -2 * (sum(log(x), na.rm  = TRUE))
  pval <- pchisq(q = test_stat, df = 2 * length(x), lower.tail = FALSE)
  return(pval)
}

# split into class, family, and subfamily and calculate mean R and combined pValues
cors_cons[, c("class", "family", "subfamily") := tstrsplit(feature_id2, "\\.")]
by_family <- cors_cons[, .(mean.r = mean(r, na.rm = TRUE),
                           fisher.p = meta_fisher(pValue)), 
                           by = c("feature_id", "family")]

ggplot(by_family, aes(x = feature_id, y = family, color = mean.r, size = -log10(fisher.p))) +
  geom_point() +
  scale_color_viridis_c() +
  labs(title = "Consensus Gene Significant (p < 0.05) Correlations with RE Families",
       x = "Protein Coding Gene",
       y = "RE Family",
       color = "avg. r",
       size = "-log10(fisher.p)") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 3))
ggsave(here("results", "pahi", "figures", "geneREfamily-correlations.png"), width = 11, height = 7)
```

## CoExpression analysis

Will co-expression analysis reveal anything interesting?

### Read in normalized data for each experiment

```{r}
# read in the lcpm data for each experiment
gene_lcpm_files <- list.files(
  path = here("results"),
  pattern = "gene-lcpms.rds",
  recursive = TRUE,
  full.names = TRUE
)

re_lcpm_files <- list.files(
  path = here("results"),
  pattern = "re-lcpms.rds",
  recursive = TRUE,
  full.names = TRUE
)

names(gene_lcpm_files) <- regmatches(gene_lcpm_files, regexpr("PRJNA[0-9]+", gene_lcpm_files))
names(re_lcpm_files) <- regmatches(re_lcpm_files, regexpr("PRJNA[0-9]+", re_lcpm_files))
gene_lcpm_mats <- lapply(gene_lcpm_files, readRDS) 
re_lcpm_mats <- lapply(re_lcpm_files, readRDS)
```

Get the BioSample level metadata to filter for PAHi samxples

```{r}
# Read in and clean up the biosample metadata
biosample_meta <- fread(here("doc", "sample-metadata", "sample-metadata - metadata.tsv"),
                        select = c("BioSample", "LibrarySelection", "LibraryLayout", "Model",
                                   "BioProject", "title", "CELL_INFO", "TREATMENT_INFO", 
                                   "DOSE_INFO", "TIME_INFO"))
biosample_cells <- fread(here("doc", "sample-metadata", "sample-metadata - cells.tsv"))
biosample_drugs <- fread(here("doc", "sample-metadata", "sample-metadata - drugs.tsv"))
biosample_meta <- unique(biosample_meta)
biosample_meta <- merge(biosample_meta, biosample_cells, by = "CELL_INFO", all.x = TRUE, all.y = FALSE)
biosample_meta <- merge(biosample_meta, biosample_drugs, by = "TREATMENT_INFO", all.x = TRUE, all.y = FALSE)

# Get the PAHi BioSample IDs
pahi_biosamples <- unique(biosample_meta[EPIGENETIC_CLASS == "PAHi", BioSample])
```

Filter out the matrices with the PAHi samples

```{r}
# Filter the lcpm mats for biosamples
gene_lcpms.filt <- lapply(gene_lcpm_mats, function(M) M[, colnames(M) %in% pahi_biosamples])
gene_lcpms.filt <- lapply(gene_lcpms.filt, function(M) { if (ncol(M) > 0) return(M) else return(NA) })
gene_lcpms.filt <- gene_lcpms.filt[!is.na(gene_lcpms.filt)]

re_lcpms.filt <- lapply(re_lcpm_mats, function(M) M[, colnames(M) %in% pahi_biosamples])
re_lcpms.filt <- lapply(re_lcpms.filt, function(M) { if (ncol(M) > 0) return(M) else return(NA) })
re_lcpms.filt <- re_lcpms.filt[!is.na(re_lcpms.filt)]
```

Get the common Genes/REs across all matrices

```{r}
universal_genes <- Reduce(intersect, lapply(gene_lcpms.filt, rownames))
universal_res <- Reduce(intersect, lapply(re_lcpms.filt, rownames))

gene_lcpm.univ <- lapply(gene_lcpms.filt, function(M) M[universal_genes, ])
re_lcpm.univ <- lapply(re_lcpms.filt, function(M) M[universal_res, ])
```

Co-expression analysis on the TMM normed counts

```{r}
library(coseq)


gene_lcpm.comb <- do.call(cbind, gene_lcpm.univ)
re_lcpm.comb <- do.call(cbind, re_lcpm.univ)
comb.mat <- rbind(gene_lcpm.comb, re_lcpm.comb)

# ---
gene.run <- coseq(
  gene_lcpm.comb,
  K = 2:15,
  model = "kmeans",
  transformation = "none", 
  normFactors = "none",
  meanFilterCutoff = 0,
  parallel = TRUE,
  BPPARAM =  BiocParallel::MulticoreParam(workers = 12),
  seed = 1234
)

re.run <- coseq(
  re_lcpm.comb,
  K = 2:15,
  model = "kmeans",
  transformation = "none", 
  normFactors = "none",
  meanFilterCutoff = 0,
  parallel = TRUE,
  BPPARAM =  BiocParallel::MulticoreParam(workers = 12),
  seed = 1234
)

comb.run <- coseq(
  comb.mat,
  K = 2:15,
  model = "kmeans",
  transformation = "none", 
  normFactors = "none",
  meanFilterCutoff = 0,
  parallel = TRUE,
  BPPARAM =  BiocParallel::MulticoreParam(workers = 12),
  seed = 1234
)
```

Plot the cluster profiles

```{r}
# Gene expression only
gene.comb_dt <- as.data.table(gene_lcpm.comb, keep.rownames = "feature_id")
gene.comb_dt.m <- melt(gene.comb_dt, id.vars = "feature_id", variable.name = "BioSample", value.name = "logCPM")
gene_run_cluster_dt <- data.table(feature_id = names(clusters(gene.run)), cluster = factor(clusters(gene.run)))
gene.comb_dt.m <- merge(gene.comb_dt.m, gene_run_cluster_dt, by = "feature_id", all.x = TRUE, all.y = FALSE)
gene.comb_dt.m <- merge(gene.comb_dt.m, biosample_meta, by = "BioSample", all.x = TRUE, all.y = FALSE)

gene_clusters <- ggplot(gene.comb_dt.m[!is.na(cluster)], 
       aes(x = cluster, y = logCPM, fill = TREATMENT_INFO)) +
  geom_boxplot(outlier.shape = NA) +
  labs(title = "Gene Expression Clusters By Drug",
       x = "Cluster ID",
       y = "logCPM",
       fill = "Drug") +
  theme_light() +
  theme(legend.position = "bottom", plot.title = element_text(size = 18, face = "bold"))

# RE clusters ---
re.comb_dt <- as.data.table(re_lcpm.comb, keep.rownames = "feature_id")
re.comb_dt.m <- melt(re.comb_dt, id.vars = "feature_id", variable.name = "BioSample", value.name = "logCPM")
re_run_cluster_dt <- data.table(feature_id = names(clusters(re.run)), cluster = factor(clusters(re.run)))
re.comb_dt.m <- merge(re.comb_dt.m, re_run_cluster_dt, by = "feature_id", all.x = TRUE, all.y = FALSE)
re.comb_dt.m <- merge(re.comb_dt.m, biosample_meta, by = "BioSample", all.x = TRUE, all.y = FALSE)

re_clusters <- ggplot(re.comb_dt.m[!is.na(cluster)], 
       aes(x = cluster, y = logCPM, fill = TREATMENT_INFO)) +
  geom_boxplot(outlier.shape = NA) +
  labs(title = "RE Expression Clusters By Drug",
       x = "Cluster ID",
       y = "logCPM",
       fill = "Drug") +
  theme_light() +
  theme(legend.position = "bottom", plot.title = element_text(size = 18, face = "bold"))

# Create patchwork
(gene_clusters | re_clusters) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
ggsave(here("results", "pahi", "figures", "coseq-clusters-by-drug.png"), width = 18, height = 8)
```

## What REs are driving these clusters?

```{r}
library(forcats)

re.comb_dt.m[, c("class", "family", "subfamily") := tstrsplit(feature_id, "\\.")]
ggplot(re.comb_dt.m[!is.na(cluster), 
                    .(mean_logCPM = mean(logCPM, na.rm = TRUE),
                      sd_logCPM = sd(logCPM, na.rm = TRUE),
                     N = .N), 
                    by = c("cluster", "family", "TREATMENT_INFO")], 
       aes(x = fct_reorder(family, mean_logCPM, max), y = mean_logCPM, fill = factor(TREATMENT_INFO))) +
  geom_boxplot(outlier.shape = NA) +
  labs(title = "Family-level RE Expression Per Drug",
       x = NULL,
       y = "mean logCPM",
       fill = "Drug") +
  theme_light() +
  theme(
    legend.position = "bottom", 
    axis.text.x = element_text(angle = 45, hjust = 1), 
    plot.title = element_text(size = 18, face = "bold"))
ggsave(here("results", "pahi", "figures", "re-family-expression.png"), width = 18, height = 6)
```

```{r}
# Number of samples per cluster 
pahi_tbl <- biosample_meta[EPIGENETIC_CLASS == "PAHi", .N, by = TREATMENT_INFO][order(-N)]
png(here("results", "pahi", "figures", "pahi-drug-table.png"), height = 50 * nrow(pahi_tbl), width = 150 * ncol(pahi_tbl))
grid.table(pahi_tbl, rows = NULL)
dev.off()
```

Drug descriptions?

```{r}
desc_tbl <- unique(biosample_meta[EPIGENETIC_CLASS == "PAHi", .(TREATMENT_INFO, DESC)])
png(here("results", "pahi", "figures", "pahi-desc-table.png"), height = 50 * nrow(desc_tbl), width = 1200 * ncol(desc_tbl))
grid.table(desc_tbl, rows = NULL)
dev.off()
```

---

## What is dBET6 doing on the contrast level?

```{r}
# what are the ids with dBET6 treatment?
pca.dge$metadata[pca.dge$metadata$drug == "dBET6", ]
```

### Explore DE results for the dBET6 data points

```{r}
# PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr
v1 <- plot_volcano(dge_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 2hr - MOLT4 cell line")

m1 <- plot_md(dge_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 2hr - MOLT4 cell line")


# PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr
v2 <- plot_volcano(dge_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 6hr - MOLT4 cell line")

m2 <- plot_md(dge_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 6hr - MOLT4 cell line")


# PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO
v3 <- plot_volcano(dge_dt[id == "PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - TALL PDX cells")

m3 <- plot_md(dge_dt[id == "PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - TALL PDX cells")

# PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO
v4 <- plot_volcano(dge_dt[id == "PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - Primary T cells")

m4 <- plot_md(dge_dt[id == "PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - Primary T cells")


# create patchwork
(v1 | v2) / (v3 | v4) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Protein Coding Gene Expression") &
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "gene-volcano.png"), width = 18, height = 10)

# create patchwork
(m1 | m2) / (m3 | m4) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Protein Coding Gene Expression") &
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "gene-md.png"), width = 18, height = 10)
```

```{r}
# PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr
v1 <- plot_volcano(dge_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 2hr - MOLT4 cell line")

m1 <- plot_md(dre_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_2hr"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 2hr - MOLT4 cell line")


# PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr
v2 <- plot_volcano(dre_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 6hr - MOLT4 cell line")

m2 <- plot_md(dre_dt[id == "PRJNA315414.MOLT4.dBET6_vs_MOLT4.DMSO_6hr"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - 6hr - MOLT4 cell line")


# PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO
v3 <- plot_volcano(dre_dt[id == "PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - TALL PDX cells")

m3 <- plot_md(dre_dt[id == "PRJNA315414.TALL_PDX.dBET6_vs_TALL_PDX.DMSO"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - TALL PDX cells")

# PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO
v4 <- plot_volcano(dre_dt[id == "PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO"], 
             fdr = 0.1, 
             lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - Primary T cells")

m4 <- plot_md(dre_dt[id == "PRJNA315414.primary_T_cell.dBET6_vs_primary_T_cell.DMSO"], 
        fdr = 0.1, 
        lfc = log2(1.5)) +
  ggtitle("dBET6 vs DMSO - Primary T cells")

# create patchwork
(v1 | v2) / (v3 | v4) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Repetitive Element Expression") &
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "re-volcano.png"), width = 18, height = 10)

# create patchwork
(m1 | m2) / (m3 | m4) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Repetitive Element Expression") &
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "re-md.png"), width = 18, height = 10)
```

```{r}
suppressPackageStartupMessages(library(MultiAssayExperiment))


PRJNA315414_gene_lcpms <- readRDS(here("results", "PRJNA315414", "rds-files", "gene-lcpms.rds"))
PRJNA315414_re_lcpms <- readRDS(here("results", "PRJNA315414", "rds-files", "re-lcpms.rds"))
PRJNA315414_mae <- readRDS(here("data", "PRJNA315414", "MultiAssayExperiment.rds"))
PRJNA315414_metadata <- as.data.frame(colData(PRJNA315414_mae))
rownames(PRJNA315414_metadata) <- PRJNA315414_metadata$BioSample

# Perform PCA on genes and REs
PRJNA315414.gene.pca <- pca(PRJNA315414_gene_lcpms, metadata = PRJNA315414_metadata, center = TRUE, scale = FALSE)
PRJNA315414.re.pca <- pca(PRJNA315414_re_lcpms, metadata = PRJNA315414_metadata, center = TRUE, scale = FALSE)

# Plot
PRJNA315414_biplot1 <- biplot(
  PRJNA315414.gene.pca, 
  colby = "source_name", 
  lab = PRJNA315414_metadata$group,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Protein Coding Gene Expression"
  )

PRJNA315414_biplot2 <- biplot(
  PRJNA315414.re.pca, 
  colby = "source_name", 
  lab = PRJNA315414_metadata$group,
  vline = 0,
  vlineType = 3,
  hline = 0,
  hlineType = 3,
  legendPosition = "bottom",
  legendLabSize = 8,
  legendTitleSize = 12,
  legendIconSize = 3,
  title = "Repetitive Element Expression"
  )

(PRJNA315414_biplot1 | PRJNA315414_biplot2) + 
  plot_layout(guides = "collect") +
  plot_annotation(title = "PRJNA315414") &
  theme(legend.position = "bottom", 
        plot.title = element_text(size = 18, face = "bold"))

ggsave(here("results", "pahi", "figures", "PRJNA315414-biplot.png"), width = 18, height = 10)
```

## How about A1874?

```{r}
a1874.gene.v <- plot_volcano(
  dge_dt[contrast == "GB1874.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A1874 50uM vs DMSO at 48hrs")

a1874.re.v <- plot_volcano(
  dre_dt[contrast == "GB1874.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A1874 50uM vs DMSO at 48hrs")

a6853.gene.v <- plot_volcano(
  dge_dt[contrast == "GB6853.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A6853 50uM vs DMSO at 48hrs")

a6853.re.v <- plot_volcano(
  dre_dt[contrast == "GB6853.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A6853 50uM vs DMSO at 48hrs")

a8679.gene.v <- plot_volcano(
  dge_dt[contrast == "GB8679.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A8679 50uM vs DMSO at 48hrs")

a8679.re.v <- plot_volcano(
  dre_dt[contrast == "GB8679.50uM_vs_DMSO_48hr"], 
  fdr = 0.1, 
  lfc = log2(1.5)) +
  ggtitle("A8679 50uM vs DMSO at 48hrs")
```

