---
title: "Leukemia Meta-Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Meta-Analysis

## Read in the DE results

```{r}
library(here)
library(data.table)


dge <- fread(here("results", "combined", "data-files", "dge-all-experiments.csv.gz"))
dre <- fread(here("results", "combined", "data-files", "dre-all-experiments.csv.gz"))
```

## Read in metadata information

```{r}
metadata <- fread(here("doc", "metadata.csv"))
drugs <- fread(here("doc", "drugs.csv"))
cells <- fread(here("doc", "cells.csv"))

# join annotations onto metadata
metadata <- merge(metadata, cells, by = "cell_line", all.x = TRUE, all.y = FALSE)
metadata <- merge(metadata, drugs, by = "drug", all.x = TRUE, all.y = FALSE)
head(metadata)
```

## Extract Leukemia contrasts

```{r}
leukemia_ids <- metadata[disease %ilike% "leukemia", id]

# extract only those leukemia results
leukemia_gene_dt <- dge[id %chin% leukemia_ids]
leukemia_re_dt <- dre[id %chin% leukemia_ids]

# split into lists
dge_list <- split(leukemia_gene_dt, by = "id")
dre_list <- split(leukemia_re_dt, by = "id")
```

## REMOVE OUTLIERS

Identified using the meta-analysis PCA tool

```{r}
outliers <- c("PRJNA524886.PDX_CBAB22694_CD45pos.1percent_VTP50469_chow.28d_vs_control")

dge_list <- dge_list[!names(dge_list) %in% outliers]
dre_list <- dre_list[!names(dre_list) %in% outliers]
```

## Meta-Analysis

```{r}
library(coriell)


# gene-expression 
dge_vote <- meta_vote(dge_list, meta_prop = 0.25, pval = 0.1)
dge_comb <- meta_pcombine(
  dge_list, 
  method = "fisher", 
  lfc_fun = mean, 
  na.rm = TRUE)

# REs
dre_vote <- meta_vote(dre_list, meta_prop = 0.25, pval = 0.1)
dre_comb <- meta_pcombine(
  dre_list, 
  method = "fisher",
  lfc_fun = median,
  na.rm = TRUE,
  plot = FALSE)
```


```{r}
library(ggplot2)
library(patchwork)
library(ggrepel)


# plot vote counting results
vote_genes <- plot_metavolcano(dge_vote) + 
  ggtitle("Protein Coding Genes") +
  geom_text_repel(data = dge_vote[vote != "unperturbed"])

vote_res <- plot_metavolcano(dre_vote) + 
  ggtitle("Repetitive Elements") +
  geom_text_repel(data = dre_vote[vote != "unperturbed"])
  
# plot p-combine results
pcomb_genes <- plot_volcano(dge_comb, x = meta_lfc, y = meta_p, lab = feature_id, lfc = log2(2), label_sig = TRUE) +
  labs(title = "Protein Coding Genes",
       x = "Mean logFC",
       y = "-log10(Meta P-value)")

pcomb_res <- plot_volcano(dre_comb, x = meta_lfc, y = meta_p, lab = feature_id, lfc = log2(2), label_sig = TRUE) +
  labs(title = "Repetitive Elements",
       x = "Mean logFC",
       y = "-log10(Meta P-value)")

((vote_genes / pcomb_genes) | (vote_res / pcomb_res)) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Leukemia Meta-Analysis", 
                  theme = theme(plot.title = element_text(size = 24, face = "bold"))) &
  theme(legend.position = "bottom")
ggsave(here("results", "leukemia", "meta-analysis.png"), width = 18, height = 10)
```

---

# Analysis on logFC values

## Read in the SummarizedExperiments

```{r}
suppressPackageStartupMessages(library(SummarizedExperiment))


dge_se <- readRDS(here("results", "combined", "rds-files", "dge_se.rds"))
dre_se <- readRDS(here("results", "combined", "rds-files", "dre_se.rds"))
```

## Filter for Leukemia Samples

```{r}
leukemia_dge <- dge_se[, dge_se$disease %ilike% "leukemia"]
leukemia_dre <- dre_se[, dre_se$disease %ilike% "leukemia"]

# Remove Heat shock treatment cells
leukemia_dge <- leukemia_dge[, leukemia_dge$experiment != "PRJNA510428"]
leukemia_dre <- leukemia_dre[, leukemia_dre$experiment != "PRJNA510428"]

# extract LFC matrices
gene_lfc <- assay(leukemia_dge, "lfc")
re_lfc <- assay(leukemia_dre, "lfc")

# Extract the metadata information
leukemia_meta <- as.data.frame(colData(leukemia_dge))

# Replace some missing values
leukemia_meta[is.na(leukemia_meta$epigenetic_class), "epigenetic_class"] <- "NOT-EPIGENETIC"
```

## PCA on logFC values

```{r}
library(PCAtools)


dge.pca <- pca(gene_lfc, leukemia_meta, scale = FALSE, center = TRUE, removeVar = 0.1)
dre.pca <- pca(re_lfc, leukemia_meta, scale = FALSE, center = TRUE, removeVar = 0.1) 
```

```{r}
# Create better color palette
epi_classes <- unique(leukemia_meta$epigenetic_class)
epi_colors <- RColorBrewer::brewer.pal(length(epi_classes), "Set1")
names(epi_colors) <- epi_classes

gene_biplot <- biplot(
  dge.pca, 
  colby = "epigenetic_class", 
  hline = 0, 
  hlineType = 3, 
  vline = 0, 
  vlineType = 3,
  lab = leukemia_meta$drug,
  title = "PCA on logFC of Protein Coding Genes",
  legendPosition = "bottom",
  colkey = epi_colors,
  colLegendTitle = "Epigenetic Class"
  )

re_biplot <- biplot(
  dre.pca, 
  colby = "epigenetic_class", 
  hline = 0, 
  hlineType = 3, 
  vline = 0, 
  vlineType = 3,
  lab = leukemia_meta$drug,
  title = "PCA on logFC of Repetitive Elements",
  legendPosition = "bottom",
  colkey = epi_colors,
  colLegendTitle = "Epigenetic Class"
  )

(gene_biplot | re_biplot) +
  plot_annotation(title = "Leukemia Samples",
                  theme = theme(plot.title = element_text(size = 24, face = "bold"))) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")
ggsave(here("results", "leukemia", "biplot.png"), width = 18, height = 10)
```

## Correlation between genes and REs in leukemia samples

```{r}
# bind genes and REs into single matrix
mat <- cbind(t(gene_lfc), t(re_lfc))

# pairwise correlation between all genes and all REs for leukemia samples
cor_mat <- cor(mat, method = "spearman")

# pivot longer into data.table -- feature_1 genes and feature_2 REs
cor_dt <- as.data.table(cor_mat, keep.rownames = "feature_1")
cor_dt.m <- melt(
  cor_dt, 
  id.vars = "feature_1", 
  variable.name = "feature_2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

cor_dt.m2 <- cor_dt.m[feature_1 %chin% rownames(gene_lfc) & feature_2 %chin% rownames(re_lfc)]
sig_genes <- unique(leukemia_gene_dt[FDR < 0.01 & logFC > 0, feature_id])

ggplot(cor_dt.m2[feature_1 %chin% sig_genes][cor > 0.9], 
       aes(x = fct_reorder(feature_1, cor), y = feature_2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "Up-Regulated Protein Coding Genes vs RE Correlation in Leukemia Samples",
       x = "Protein Coding Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "gene-by-re-correlation.png"), width = 18, height = 10)
```

## GO on the sig genes

```{r}
cor_genes <- cor_dt.m2[feature_1 %chin% sig_genes][cor > 0.9, feature_1]


go_bp <- coriell::panther_go(cor_genes, organism = "9606", annot_dataset =  "panther_go_slim_bp")
go_mf <- coriell::panther_go(cor_genes, organism = "9606", annot_dataset =  "panther_go_slim_mf")
go_bp$table[, term := as.character(unlist(term))]
go_mf$table[, term := as.character(unlist(term))]

fwrite(go_bp$table, here("results", "leukemia", "GO-biological-process.tsv"), sep = "\t")
fwrite(go_mf$table, here("results", "leukemia", "GO-molecular-function.tsv"), sep = "\t")
```

## Interferon Response

```{r}
# read in all gene set pathways
gene_sets <- readRDS(here("doc", "msigdb.v7.4.symbols.rds"))
ifn_alpha <- gene_sets[["HALLMARK_INTERFERON_ALPHA_RESPONSE"]]
ifn_gamma <- gene_sets[["HALLMARK_INTERFERON_GAMMA_RESPONSE"]]

ifna_mat <- gene_lfc[rownames(gene_lfc) %in% ifn_alpha, ]
ifng_mat <- gene_lfc[rownames(gene_lfc) %in% ifn_gamma, ]
```

### PCA on only ifn genes

```{r}
ifna.pca <- pca(ifna_mat, leukemia_meta, scale = FALSE, center = TRUE, removeVar = 0.1)
ifng.pca <- pca(ifng_mat, leukemia_meta, scale = FALSE, center = TRUE, removeVar = 0.1) 
```


```{r}
ifna_biplot <- biplot(
  ifna.pca, 
  colby = "epigenetic_class", 
  hline = 0, 
  hlineType = 3, 
  vline = 0, 
  vlineType = 3,
  lab = NULL,
  title = "PCA on logFC of Interferon Alpha Response Genes",
  legendPosition = "bottom",
  colkey = epi_colors,
  colLegendTitle = "Epigenetic Class"
  )

ifng_biplot <- biplot(
  ifng.pca, 
  colby = "epigenetic_class", 
  hline = 0, 
  hlineType = 3, 
  vline = 0, 
  vlineType = 3,
  lab = NULL,
  title = "PCA on logFC of Interferon Gamma Response Genes",
  legendPosition = "bottom",
  colkey = epi_colors,
  colLegendTitle = "Epigenetic Class"
  )

(ifna_biplot | ifng_biplot) +
  plot_annotation(title = "Leukemia Samples",
                  theme = theme(plot.title = element_text(size = 24, face = "bold"))) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")
ggsave(here("results", "leukemia", "biplot-ifn-noLabel.png"), width = 18, height = 10)
```

## Get samples correlated with IFN expression

```{r}
# Cluster columns (samples) by IFN expression
ifna_clust <- hclust(dist(t(ifna_mat), method = "euclidean"), method = "ward.D2")
ifng_clust <- hclust(dist(t(ifng_mat), method = "euclidean"), method = "ward.D2")

# height of 2 seems to reflect the data
ifna_clusters <- cutree(ifna_clust, k = 2)
ifng_clusters <- cutree(ifng_clust, k = 2)

# check rows can be bound
all(names(ifna_clusters) == rownames(leukemia_meta))

# Get annotation data
col_df <- leukemia_meta[, c("epigenetic_class"), drop = FALSE]
col_df$IFNa_cluster <- factor(ifna_clusters)
ann_colors = list(epigenetic_class = epi_colors, IFNa_cluster = c("1" = "firebrick", "2" = "steelblue"))

coriell::quickmap(
  ifna_mat, 
  scale = "none", 
  diverging_palette = TRUE,
  show_colnames = FALSE,
  main = "INF Alpha Response Genes",
  cutree_cols = 2,
  annotation_col = col_df,
  annotation_colors = ann_colors,
  filename = here("results", "leukemia", "heatmap-ifna.png")
  )

coriell::quickmap(
  ifng_mat, 
  scale = "none", 
  diverging_palette = TRUE,
  show_colnames = FALSE,
  main = "INF Gamma Response Genes",
  cutree_cols = 2,
  annotation_col = col_df,
  annotation_colors = ann_colors,
  filename = here("results", "leukemia", "heatmap-ifng.png")
  )
```

Do the samples with relatively higher IFNa expression correspond to up-regulated REs?

```{r}
coriell::quickmap(
  re_lfc, 
  scale = "none", 
  clustering_distance_rows = "euclidean",
  diverging_palette = TRUE,
  show_colnames = FALSE,
  main = "Repetitive Element Expression",
  annotation_col = col_df,
  annotation_colors = ann_colors,
  filename = here("results", "leukemia", "heatmap-re-ifna.png")
  )
```

## Compare gene and RE expression

```{r}
dt <- rbindlist(list("gene" = dge, "repElem" = dre), idcol = "type")
dt[, direction := fcase(FDR < 0.1 & logFC < 0, "down",
                        FDR < 0.1 & logFC > 0, "up",
                        default = "unperturbed")]

# count the direction for each features across all leukemia samples
sig_counts <- dt[id %chin% leukemia_ids, .(count = .N), by = c("feature_id", "direction")]
genes <- unique(dge$feature_id)
res <- unique(dre$feature_id)
sig_counts[, type := fcase(feature_id %chin% ifn_alpha, "IFNa",
                           feature_id %chin% genes, "gene",
                           feature_id %chin% res, "re",
                           default = "unknown")]

# Get the most DE genes/REs/IFNa genes
top_genes <- dcast(
  sig_counts[type == "gene"], 
  feature_id ~ direction, 
  value.var = "count", 
  fill = 0)[, n_de := sum(down, up), by = "feature_id"][
    order(-n_de)][1:25, feature_id]

top_res <- dcast(
  sig_counts[type == "re"], 
  feature_id ~ direction, 
  value.var = "count", 
  fill = 0)[, n_de := sum(down, up), by = "feature_id"][
    order(-n_de)][1:25, feature_id]

top_ifna <- dcast(
  sig_counts[type == "IFNa"], 
  feature_id ~ direction, 
  value.var = "count", 
  fill = 0)[, n_de := sum(down, up), by = "feature_id"][
    order(-n_de)][1:25, feature_id]

# redefine down counts to be in the negative direction so axis can be centered on 0
sig_counts[direction == "down", count := -count]
```

plot top features

```{r}
library(forcats)


ggplot(sig_counts[direction != "unperturbed" & (feature_id %chin% top_ifna | feature_id %chin% top_res)], 
       aes(x = fct_reorder(feature_id, abs(count)), y = count, color = direction)) +
  geom_point(size = 3) + 
  coord_flip() +
  scale_y_continuous(
    limits = c(-60, 60),
    breaks = seq(-60, 60, 10), 
    labels = abs(seq(-60, 60, 10))
    ) +
  scale_color_manual(values = c("up" = "firebrick", "down" = "steelblue")) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(title = "Top Differentially Expressed IFN\u03B1 genes and REs in Leukemia Experiments (N=221)",
       y = "N Experiments DE",
       x = NULL,
       color = "Direction of Expression") +
  theme_light() +
  theme(legend.position = "bottom", plot.title = element_text(face = "bold"))

ggsave(here("results", "leukemia", "dotplot-top_features.png"), width = 11, height = 7)
```

## Pairwise correlations of features

```{r}
all(rownames(t(re_lfc)) == rownames(t(ifna_mat)))
feature_mat <- cbind(t(ifna_mat), t(re_lfc))
feature_cors <- cor(feature_mat, method = "spearman")

cor_dt <- as.data.table(feature_cors, keep.rownames = "feature_id")
cor_dt.m <- melt(
  cor_dt, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
cor_dt.filt <- cor_dt.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
cor_dt.filt.mat <- as.matrix(dcast(cor_dt.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals <- apply(cor_dt.filt.mat, 2, function(x) max(abs(x)))
top_re <- names(sort(cor_vals, decreasing = TRUE)[1:25])

ggplot(cor_dt.filt[feature_id2 %chin% top_re], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-correlation.png"), width = 11, height = 7)
```

## Pairwise correlation of only the cluster 2 samples

```{r}
cluster2_mat <- feature_mat[names(ifna_clusters[ifna_clusters == 2]), ]
cluster2_cors <- cor(cluster2_mat, method = "spearman")

cor_dt2 <- as.data.table(cluster2_cors, keep.rownames = "feature_id")
cor_dt.m2 <- melt(
  cor_dt2, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
cor_dt.filt2 <- cor_dt.m2[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
cor_dt.filt2.mat <- as.matrix(dcast(cor_dt.filt2, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals2 <- apply(cor_dt.filt2.mat, 2, function(x) max(abs(x)))
top_re2 <- names(sort(cor_vals2, decreasing = TRUE)[1:25])

ggplot(cor_dt.filt2[feature_id2 %chin% top_re2], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in Cluster 2 Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-cluster2-correlation.png"), width = 11, height = 7)
```

## Correlate by drug type

### PAHi

```{r}
pahi_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "PAHi", ])
pahi_mat <- feature_mat[pahi_ids, ]
pahi_cors <-  cor(pahi_mat, method = "spearman")

pahi <- as.data.table(pahi_cors, keep.rownames = "feature_id")
pahi.m <- melt(
  pahi, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
pahi.filt <- pahi.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
pahi.filt.mat <- as.matrix(dcast(pahi.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.pahi <- apply(pahi.filt.mat, 2, function(x) max(abs(x)))
top_re.pahi <- names(sort(cor_vals.pahi, decreasing = TRUE)[1:25])

ggplot(pahi.filt[feature_id2 %chin% top_re.pahi], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in PAHi Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-PAHi-correlation.png"), width = 11, height = 7)
```

### HDACi

```{r}
hdaci_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "HDACi", ])
hdaci_mat <- feature_mat[hdaci_ids, ]
hdaci_cors <-  cor(hdaci_mat, method = "spearman")

hdaci <- as.data.table(hdaci_cors, keep.rownames = "feature_id")
hdaci.m <- melt(
  hdaci, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
hdaci.filt <- hdaci.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
hdaci.filt.mat <- as.matrix(dcast(hdaci.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.hdaci <- apply(hdaci.filt.mat, 2, function(x) max(abs(x)))
top_re.hdaci <- names(sort(cor_vals.hdaci, decreasing = TRUE)[1:25])

ggplot(hdaci.filt[feature_id2 %chin% top_re.hdaci], 
       aes(x = fct_reorder(feature_id, cor, max), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in HDACi Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-hdaci-correlation.png"), width = 11, height = 7)
```

### HMTi

```{r}
hmti_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "HMTi", ])
hmti_mat <- feature_mat[hmti_ids, ]
hmti_cors <-  cor(hmti_mat, method = "spearman")

hmti <- as.data.table(hmti_cors, keep.rownames = "feature_id")
hmti.m <- melt(
  hmti, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
hmti.filt <- hmti.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
hmti.filt.mat <- as.matrix(dcast(hmti.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.hmti <- apply(hmti.filt.mat, 2, function(x) max(abs(x)))
top_re.hmti <- names(sort(cor_vals.hmti, decreasing = TRUE)[1:25])

ggplot(hmti.filt[feature_id2 %chin% top_re.hmti], 
       aes(x = fct_reorder(feature_id, cor, max), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in HMTi Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-hmti-correlation.png"), width = 11, height = 7)
```

### DNMTi

```{r}
dnmti_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "DNMTi", ])
dnmti_mat <- feature_mat[dnmti_ids, ]
dnmti_cors <-  cor(dnmti_mat, method = "spearman")

dnmti <- as.data.table(dnmti_cors, keep.rownames = "feature_id")
dnmti.m <- melt(
  dnmti, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
dnmti.filt <- dnmti.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
dnmti.filt.mat <- as.matrix(dcast(dnmti.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.dnmti <- apply(dnmti.filt.mat, 2, function(x) max(abs(x)))
top_re.dnmti <- names(sort(cor_vals.dnmti, decreasing = TRUE)[1:25])

ggplot(dnmti.filt[feature_id2 %chin% top_re.dnmti], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in DNMTi Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-dnmti-correlation.png"), width = 11, height = 7)
```

### Combination

```{r}
combo_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "COMBINATION", ])
combo_mat <- feature_mat[combo_ids, ]
combo_cors <-  cor(combo_mat, method = "spearman")

combo <- as.data.table(combo_cors, keep.rownames = "feature_id")
combo.m <- melt(
  combo, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
combo.filt <- combo.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
combo.filt.mat <- as.matrix(dcast(combo.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.combo <- apply(combo.filt.mat, 2, function(x) max(abs(x)))
top_re.combo <- names(sort(cor_vals.combo, decreasing = TRUE)[1:25])

ggplot(combo.filt[feature_id2 %chin% top_re.combo], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in Combination Drugs Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-combo-correlation.png"), width = 11, height = 7)
```

### Other

```{r}
other_ids <- rownames(leukemia_meta[leukemia_meta$epigenetic_class == "OTHER", ])
other_mat <- feature_mat[other_ids, ]
other_cors <-  cor(other_mat, method = "spearman")

other <- as.data.table(other_cors, keep.rownames = "feature_id")
other.m <- melt(
  other, 
  id.vars = "feature_id", 
  variable.name = "feature_id2",
  variable.factor = FALSE,
  value.name = "cor")[between(cor, lower = -1, upper = 1, incbounds = FALSE)]

# filter for IFNa genes and RE correlations
other.filt <- other.m[feature_id %chin% ifn_alpha & feature_id2 %chin% res][order(-abs(cor))]

# cast wider
other.filt.mat <- as.matrix(dcast(other.filt, feature_id ~ feature_id2, value.var = "cor"), rownames = "feature_id")

# Get the best correlation for each column
cor_vals.other <- apply(other.filt.mat, 2, function(x) max(abs(x)))
top_re.other <- names(sort(cor_vals.other, decreasing = TRUE)[1:25])

ggplot(other.filt[feature_id2 %chin% top_re.other], 
       aes(x = fct_reorder(feature_id, cor), y = feature_id2)) +
  geom_raster(aes(fill = cor)) +
  scale_fill_viridis_c() +
  labs(title = "IFN\u03B1 Genes vs RE Correlation in Other Drug Leukemia Samples",
       x = "IFN\u03B1 Gene",
       y = "Repetitive Element") +
  theme_light() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1))

ggsave(here("results", "leukemia", "ifna-re-other-correlation.png"), width = 11, height = 7)
```

