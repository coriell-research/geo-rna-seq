---
title: "Find Control REs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in Qsmooth normalizeed lcpms

```{r}
library(here)


gene_files <- list.files(
  path = here("results"),
  pattern = "gene-lcpms.rds",
  recursive = TRUE,
  full.names = TRUE
)

repeat_files <- list.files(
  path = here("results"),
  pattern = "re-lcpms.rds",
  recursive = TRUE,
  full.names = TRUE
)

gene_mats <- lapply(gene_files, readRDS)
repeat_mats <- lapply(repeat_files, readRDS)
```

## Calculate the MAD and variance for each feature

```{r}
library(matrixStats)


gene_mads <- lapply(gene_mats, rowMads, useNames = TRUE)
gene_vars <- lapply(gene_mats, rowVars, useNames = TRUE)
repeat_mads <- lapply(repeat_mats, rowMads, useNames = TRUE)
repeat_vars <- lapply(repeat_mats, rowVars, useNames = TRUE)

# sort each vector
gene_mads_sorted <- lapply(gene_mads, sort)
gene_vars_sorted <- lapply(gene_vars, sort)
repeat_mads_sorted <- lapply(repeat_mads, sort)
repeat_vars_sorted <- lapply(repeat_vars, sort)
```

Extract top 100 features from each list, and get the intersection.

```{r}
top_genes_by_mad <- Reduce(intersect, lapply(gene_mads_sorted, function(x) names(head(x, n = 100))))
top_genes_by_var <- Reduce(intersect, lapply(gene_vars_sorted, function(x) names(head(x, n = 100))))
top_repeats_by_mad <- Reduce(intersect, lapply(repeat_mads_sorted, function(x) names(head(x, n = 100))))
top_repeats_by_var <- Reduce(intersect, lapply(repeat_vars_sorted, function(x) names(head(x, n = 100))))
```

There is no overlap. Instead of finding the intersection, calculate the 
frequency observed in the top 100

```{r}
top_genes_mad_freq <- table(unlist(lapply(gene_mads_sorted, function(x) names(head(x, n = 500)))))
top_genes_var_freq <- table(unlist(lapply(gene_vars_sorted, function(x) names(head(x, n = 500)))))
top_repeats_mad_freq <- table(unlist(lapply(repeat_mads_sorted, function(x) names(head(x, n = 100)))))
top_repeats_var_freq <- table(unlist(lapply(repeat_vars_sorted, function(x) names(head(x, n = 100)))))

# View the top genes/repeats for each
head(sort(top_genes_mad_freq, decreasing = TRUE) / length(gene_mads_sorted))
head(sort(top_genes_var_freq, decreasing = TRUE) / length(gene_vars_sorted))
head(sort(top_repeats_mad_freq, decreasing = TRUE) / length(repeat_mads_sorted))
head(sort(top_repeats_var_freq, decreasing = TRUE) / length(repeat_vars_sorted))
```

## Plot the top features 

```{r}
library(ggplot2)
library(data.table)
library(forcats)


genes_mad_dt <- data.table(top_genes_mad_freq)
genes_var_dt <- data.table(top_genes_var_freq)
repeats_mad_dt <- data.table(top_repeats_mad_freq)
repeats_var_dt <- data.table(top_repeats_var_freq)
setnames(genes_mad_dt, old = c("V1", "N"), new = c("feature_id", "freq"))
setnames(genes_var_dt, old = c("V1", "N"), new = c("feature_id", "freq"))
setnames(repeats_mad_dt, old = c("V1", "N"), new = c("feature_id", "freq"))
setnames(repeats_var_dt, old = c("V1", "N"), new = c("feature_id", "freq"))

# calculate the proportion of times observed
genes_mad_dt[, prop := freq / length(gene_mads_sorted)]
genes_var_dt[, prop := freq / length(gene_vars_sorted)]
repeats_mad_dt[, prop := freq / length(repeat_mads_sorted)]
repeats_var_dt[, prop := freq / length(repeat_vars_sorted)]
```

```{r}
library(patchwork)


plot_top_prop <- function(dt, N = 25) {
  ggplot(dt[order(prop, decreasing = TRUE)][1:N], aes(y = fct_reorder(feature_id, prop), x = prop)) +
    geom_point(size = 3) +
    labs(x = "Proportion of Experiments", y = NULL) +
    theme_light()
}

p1 <- plot_top_prop(genes_mad_dt) + 
  labs(title = "Top 25 Lowest Variance Genes by MAD", 
       subtitle = "By proportion of times observed in top 100 lowest MAD genes across all experiments")
p2 <- plot_top_prop(genes_var_dt) + 
  labs(title = "Top 25 Lowest Variance Genes by Variance", 
       subtitle = "By proportion of times observed in top 100 lowest variance genes across all experiments")
p3 <- plot_top_prop(repeats_mad_dt) +
  labs(title = "Top 25 Lowest Variance REs by MAD", 
       subtitle = "By proportion of times observed in top 100 lowest MAD REs across all experiments")
p4 <- plot_top_prop(repeats_var_dt) + 
  labs(title = "Top 25 Lowest Variance REs by Variance", 
       subtitle = "By proportion of times observed in top 100 lowest variance REs across all experiments")

(p1 | p2) / (p3 | p4) +
  plot_annotation(title = "Invariant Repeat Elements by MAD or Variance") +
  plot_layout(guides = "collect")
ggsave(here("results", "normalization", "figures", "invariant-repeats-madVar.png"), width = 18, height = 12)
```

## Calculate summary stats for the 'stable' repeat elements

Get 'stable' sets for different proportions of of the MAD and var measures 

```{r}
# Intersect the MAD and variance estimates
stable_10_intersect <- intersect(repeats_mad_dt[prop > 0.10, feature_id], repeats_var_dt[prop > 0.10, feature_id])
stable_25_intersect <- intersect(repeats_mad_dt[prop > 0.25, feature_id], repeats_var_dt[prop > 0.25, feature_id])
stable_33_intersect <- intersect(repeats_mad_dt[prop > 0.33, feature_id], repeats_var_dt[prop > 0.33, feature_id])
stable_50_intersect <- intersect(repeats_mad_dt[prop > 0.50, feature_id], repeats_var_dt[prop > 0.50, feature_id])

# Take the union of the MAD and variance estimates
stable_10_union <- union(repeats_mad_dt[prop > 0.10, feature_id], repeats_var_dt[prop > 0.10, feature_id])
stable_25_union <- union(repeats_mad_dt[prop > 0.25, feature_id], repeats_var_dt[prop > 0.25, feature_id])
stable_33_union <- union(repeats_mad_dt[prop > 0.33, feature_id], repeats_var_dt[prop > 0.33, feature_id])
stable_50_union <- union(repeats_mad_dt[prop > 0.50, feature_id], repeats_var_dt[prop > 0.50, feature_id])
```

Save for use in external analysis

```{r}
saveRDS(stable_10_union, here("results", "normalization", "rds-files", "stableRE-10-union.rds"))
saveRDS(stable_25_union, here("results", "normalization", "rds-files", "stableRE-25-union.rds"))
saveRDS(stable_33_union, here("results", "normalization", "rds-files", "stableRE-33-union.rds"))
saveRDS(stable_50_union, here("results", "normalization", "rds-files", "stableRE-50-union.rds"))
```

---

## Estimate variance based on biological coefficient of variation (BCV)

Get the raw counts from the MultiAssayExperiment files

```{r message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(MultiAssayExperiment))
library(edgeR)

mae_files <- list.files(
  path = here("data"),
  pattern = "MultiAssayExperiment.rds",
  recursive = TRUE,
  full.names = TRUE
)
names(mae_files) <- regmatches(mae_files, regexpr("PRJNA[0-9]+", mae_files))
maes <- lapply(mae_files, readRDS)

get_counts <- function(x) { 
  genes <- assay(x, "gene counts")
  repeats <- assay(x, "RE counts")
  counts <- rbind(genes, repeats)
  Group <- factor(x$group)
  keep <- filterByExpr(counts, group = Group)
  counts <- counts[keep, ]
  return(counts)
}

get_genes <-  function(x) { 
  genes <- assay(x, "gene counts")
  Group <- factor(x$group)
  keep <- filterByExpr(genes, group = Group)
  genes <- genes[keep, ]
  return(genes)
}

get_repeats <-  function(x) { 
  repeats <- assay(x, "RE counts")
  Group <- factor(x$group)
  keep <- filterByExpr(repeats, group = Group)
  repeats <- repeats[keep, ]
  return(repeats)
}

count_raw <- lapply(maes, get_counts)
gene_raw <- lapply(maes, get_genes)
repeat_raw <- lapply(maes, get_repeats)
```

## Estimate dispersions

```{r}
library(edgeR)


gene_disp <- parallel::mclapply(gene_raw, estimateDisp, mc.cores = 8)
repeat_disp <- parallel::mclapply(repeat_raw, estimateDisp, mc.cores = 8)
count_disp <- parallel::mclapply(count_raw, estimateDisp, mc.cores = 8)

# extract tagwise estimates
gene_tagwise <- lapply(gene_disp, function(x) x$tagwise.dispersion)
repeat_tagwise <- lapply(repeat_disp, function(x) x$tagwise.dispersion)
count_tagwise <- lapply(count_disp, function(x) x$tagwise.dispersion)
```

Use the dispersion estimates to calculate the per-feature variance then extract 
the lowest variance features.

$var = mean + mean^2 * disp$

```{r}
gene_means <- lapply(gene_raw, rowMeans)
repeat_means <- lapply(repeat_raw, rowMeans)
count_means <- lapply(count_raw, rowMeans)

calculate_bcv <- function(dispersions, means) {
  return(means + (means^2 * dispersions))
} 

gene_bcv <- mapply(calculate_bcv, dispersions = gene_tagwise, means = gene_means, SIMPLIFY = FALSE)
repeat_bcv <- mapply(calculate_bcv, dispersions = repeat_tagwise, means = repeat_means, SIMPLIFY = FALSE)
count_bcv <- mapply(calculate_bcv, dispersions = count_tagwise, means = count_means, SIMPLIFY = FALSE)

# remove features with 0 variance
gene_bcv <- lapply(gene_bcv, function(x) x[x > 0])
repeat_bcv <- lapply(repeat_bcv, function(x) x[x > 0])
count_bcv <- lapply(count_bcv, function(x) x[x > 0])

gene_bcv_sorted <- lapply(gene_bcv, sort)
repeat_bcv_sorted <- lapply(repeat_bcv, sort)
count_bcv_sorted <- lapply(count_bcv, sort)

# Get the top genes by BCV (number of times observed in lowest 100-1000)
top_genes_bcv_freq <- table(unlist(lapply(gene_bcv_sorted, function(x) names(head(x, n = 1000)))))
top_repeats_bcv_freq <- table(unlist(lapply(repeat_bcv_sorted, function(x) names(head(x, n = 500)))))
top_counts_bcv_freq <- table(unlist(lapply(count_bcv_sorted, function(x) names(head(x, n = 1000)))))

# Convert to data.tables
genes_bcv_dt <- data.table(top_genes_bcv_freq)
repeat_bcv_dt <- data.table(top_repeats_bcv_freq)
count_bcv_dt <- data.table(top_counts_bcv_freq)
setnames(genes_bcv_dt, old = c("V1", "N"), new = c("feature_id", "freq"))
setnames(repeat_bcv_dt, old = c("V1", "N"), new = c("feature_id", "freq"))
setnames(count_bcv_dt, old = c("V1", "N"), new = c("feature_id", "freq"))

# calculate the proportion of times observed
genes_bcv_dt[, prop := freq / length(gene_bcv_sorted)]
repeat_bcv_dt[, prop := freq / length(repeat_bcv_sorted)]
count_bcv_dt[, prop := freq / length(count_bcv_sorted)]
```

Plot frequency of occurrences in top 500 lowest variance features

```{r}
p1 <- plot_top_prop(genes_bcv_dt) + 
  labs(title = "Top 25 Lowest Variance Genes by BCV", 
       subtitle = "By proportion of times observed in top 1000 lowest BCV genes across all experiments")
p2 <- plot_top_prop(repeat_bcv_dt) + 
  labs(title = "Top 25 Lowest Variance Repeats by BCV", 
       subtitle = "By proportion of times observed in top 500 lowest variance REs across all experiments")
p3 <- plot_top_prop(count_bcv_dt) +
  labs(title = "Top 25 Lowest Variance Features by BCV", 
       subtitle = "By proportion of times observed in top 1000 lowest MAD features across all experiments")

(p1 | p2 | p3) +
  plot_annotation(title = "Invariant Repeat Elements by BCV") +
  plot_layout(guides = "collect")
ggsave(here("results", "normalization", "figures", "invariant-repeats-bcv.png"), width = 18, height = 6)
```

Extract the top 'stable' repeat elements

```{r}
stable_10 <- repeat_bcv_dt[prop > 0.1, feature_id]
stable_25 <- repeat_bcv_dt[prop > 0.25, feature_id]
stable_33 <- repeat_bcv_dt[prop > 0.33, feature_id]
stable_50 <- repeat_bcv_dt[prop > 0.50, feature_id]
```

## Save sets as rds files for use in other analysis

```{r}
saveRDS(stable_10, here("results", "normalization", "rds-files", "stableRE-10-bcv.rds"))
saveRDS(stable_25, here("results", "normalization", "rds-files", "stableRE-25-bcv.rds"))
saveRDS(stable_33, here("results", "normalization", "rds-files", "stableRE-33-bcv.rds"))
saveRDS(stable_50, here("results", "normalization", "rds-files", "stableRE-50-bcv.rds"))
```

---

## Rank the BCVs instead of converting back to variance

```{r}
disp_to_dt <- function(disp, mat) {
  ids <- rownames(mat)
  dt <- data.table(feature_id = ids, dispersion = disp)
  return(dt)
}

gene_disp_dts <- mapply(disp_to_dt, disp = gene_tagwise, mat = gene_raw, SIMPLIFY = FALSE)
repeat_disp_dts <- mapply(disp_to_dt, disp = repeat_tagwise, mat = repeat_raw, SIMPLIFY = FALSE)
count_disp_dts <- mapply(disp_to_dt, disp = count_tagwise, mat = count_raw, SIMPLIFY = FALSE)
gene_disp_dt <- rbindlist(gene_disp_dts, idcol = "BioProject")
repeat_disp_dt <- rbindlist(repeat_disp_dts, idcol = "BioProject")
count_disp_dt <- rbindlist(count_disp_dts, idcol = "BioProject")

gene_disp_dt[order(dispersion), ][, .SD[1:100], by = "BioProject"]
repeat_disp_dt[order(dispersion), ][, .SD[1:100], by = "BioProject"]
count_disp_dt[order(dispersion), ][, .SD[1:100], by = "BioProject"]
```

