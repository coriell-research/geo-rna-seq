---
title: "Clean Meta-DE results"
output:
  html_document:
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 4
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in DE data

```{r}
library(here)


dge_files <- list.files(
  path = here("results"),
  pattern = "dge.tsv",
  recursive = TRUE,
  full.names = TRUE
)

dre_files <- list.files(
  path = here("results"),
  pattern = "dre.tsv",
  recursive = TRUE,
  full.names = TRUE
)
```

## Read into single data.tables

```{r}
library(data.table)


dge <- setDT(
  vroom::vroom(
    dge_files,
    id = "fpath",
    delim = "\t",
    col_types = list(
      contrast = "c",
      feature_id = "c",
      logFC = "d",
      unshrunk.logFC = "d",
      logCPM = "d",
      PValue = "d",
      FDR = "d")
  )
)

dre <- setDT(
  vroom::vroom(
    dre_files,
    id = "fpath",
    delim = "\t",
    col_types = list(
      contrast = "c",
      feature_id = "c",
      logFC = "d",
      unshrunk.logFC = "d",
      logCPM = "d",
      PValue = "d",
      FDR = "d")
  )
)
```

## Clean and add variables

```{r}
# function for extracting the experiment name from the filepath
clean_fpath <- function(s) { 
  gsub("/data-files/", "", 
  gsub("/results/", "", 
  regmatches(s, 
  regexpr("\\/results\\/.*\\/", s)))) 
}

# create an experiment variable by extracting project ID from path
dge[, experiment := clean_fpath(fpath)]
dre[, experiment := clean_fpath(fpath)]
dge[, fpath := NULL]
dre[, fpath := NULL]

# combine the contrast and the experiment into a new column
# (used to differentiate same conditions in different experiments)
dge[, id := paste(experiment, contrast, sep = ".")]
dre[, id := paste(experiment, contrast, sep = ".")]

# write the results out
fwrite(dge, here("results", "combined", "data-files", "dge-all-experiments.csv.gz"))
fwrite(dre, here("results", "combined", "data-files", "dre-all-experiments.csv.gz"))
```

## Write the unique conditions out for manual annotation

I need to annotate the drugs by class/type/ something so they can be 
differentiated better on plots.

**I will have to manually edit this file since its information is not readily
available when downloading the datasets from GEO**

```{r}
fwrite(unique(dge[, .(id, experiment, contrast)]), file = here("doc", "contrast-metadata", "raw-experiment-annotation.csv"))
```

## After manual editing, read in the contrast metadata

This file comes from the shared Google Doc

```{r}
metadata <- fread(here("doc", "contrast-metadata", "contrast-metadata - metadata.tsv"))
drugs <- fread(here("doc", "contrast-metadata", "contrast-metadata - drugs.tsv"))
cells <- fread(here("doc", "contrast-metadata", "contrast-metadata - cells.tsv"))

# left join drug info onto metadata
metadata <- merge.data.table(x = metadata, 
                             y = drugs,
                             by.x = "drug",
                             by.y = "drug",
                             all.x = TRUE,
                             all.y = FALSE)

# left join cell_info onto metadata
metadata <- merge.data.table(x = metadata,
                             y = cells,
                             by.x = "cell_line",
                             by.y = "cell_line",
                             all.x = TRUE,
                             all.y = FALSE)
```

## Cast DE values into matrices

```{r}
dge_lfc_mat <- as.matrix(dcast(dge[, .(feature_id, id, logFC)],
  feature_id ~ id,
  value.var = "logFC"
), rownames = "feature_id")

dre_lfc_mat <- as.matrix(dcast(dre[, .(feature_id, id, logFC)],
  feature_id ~ id,
  value.var = "logFC"
), rownames = "feature_id")

# repeat for FDR values
dge_fdr_mat <- as.matrix(dcast(dge[, .(feature_id, id, FDR)],
  feature_id ~ id,
  value.var = "FDR"
), rownames = "feature_id")

dre_fdr_mat <- as.matrix(dcast(dre[, .(feature_id, id, FDR)],
  feature_id ~ id,
  value.var = "FDR"
), rownames = "feature_id")
```

## Replace NA values after cast

LFC values that were NA get 0 for their logFC and FDR values that were NA get 1.
Ranks have been imputed with the median rank per condition. 

```{r}
dge_lfc_mat[is.na(dge_lfc_mat)] <- 0
dre_lfc_mat[is.na(dre_lfc_mat)] <- 0
dge_fdr_mat[is.na(dge_fdr_mat)] <- 1
dre_fdr_mat[is.na(dre_fdr_mat)] <- 1
```

## Reorder metadata by matrix colnames

```{r}
# convert to data.frame with rownames for PCAtools
metadata <- data.frame(as.matrix(metadata, rownames = "id"))

# reorder metadata to match col order of matrices
metadata <- metadata[colnames(dge_lfc_mat), ]

# double-check
all(rownames(metadata) == colnames(dge_lfc_mat))
```

## Combine into a SummarizedExperiment object

This will help with managing filtering the datasets

```{r message=FALSE, warning=FALSE}
library(SummarizedExperiment)


dge_se <- SummarizedExperiment(
  assays = list(lfc = dge_lfc_mat, fdr = dge_fdr_mat),
  colData = metadata)

dre_se <- SummarizedExperiment(
  assays = list(lfc = dre_lfc_mat, fdr = dre_lfc_mat),
  colData = metadata)
```

## REMOVE OUTLIERS BEFORE WRITING OUT

Identified after plotting PCA. One experiment was done in multiple batches but
replicates were split across batches for some, making the DE analysis different
across these batches.

```{r}
outlier_contrasts <- c("PDX_CBAB22694_CD45pos.1percent_VTP50469_chow.28d_vs_control",
                       "Bortezomib_vs_DMSO_24hr.10A",
                       "Bortezomib_vs_DMSO_24hr.10B",
                       "Ciclopirox_vs_DMSO_24hr.12A",
                       "Manumycin_A_vs_DMSO_6hr.12A",
                       "SCH_79797_vs_DMSO_24hr.12A",
                       "GSK461364_vs_DMSO_24hr.10B",
                       "Sorafenib_vs_DMSO_24hr.10B",
                       "TW_37_vs_DMSO_24hr.10B",
                       "Vorinostat_vs_DMSO_24hr.10B"
                       )
dge_se <- dge_se[, !dge_se$contrast %in% outlier_contrasts]
dre_se <- dre_se[, !dre_se$contrast %in% outlier_contrasts]

# save objects out to be read into interactive visualization
saveRDS(dge_se, here("results", "combined", "rds-files", "dge_se.rds"), compress = FALSE)
saveRDS(dre_se, here("results", "combined", "rds-files", "dre_se.rds"), compress = FALSE)
```
