---
title: "Create Biosample Database"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(SummarizedExperiment))
```


## Read in all of the processed counts

Read in only the rds files that have analysis scripts

```{r}
rmd_files <- list.files(
  path = here("src"),
  pattern = "*.Rmd",
  full.names = TRUE
)

# Extract just the project names from the analysis files
projects <- gsub("\\.Rmd", "", basename(rmd_files))

# Remove PRJNA379584 which has multiple batches -- read these in separately
projects <- projects[projects != "PRJNA379584"]

# Create a list of rds-files to import based on analysis scripts
se_files <- here("results", projects, "rds-files", "se.rds")
names(se_files) <- projects

# Get the files for the experiment with multiple batches
se_files2 <- list.files(
  path = here("results", "PRJNA379584", "rds-files"),
  pattern = "se-.*.rds",
  full.names = TRUE
)

names(se_files2) <- gsub("\\.rds", "", gsub("se-", "", basename(se_files2)))
names(se_files2) <- paste0("PRJNA379584_", names(se_files2))

# CXombine all into a single vector
se_files_all <- c(se_files, se_files2)
```

Extract the colData from all processed files

```{r}
ses <- lapply(se_files_all, readRDS)

# Extract the colData for each experiment into
coldata <- rbindlist(
  lapply(ses, function(x) as.data.table(data.frame(colData(x)[, c("BioSample", "group")]))), 
  idcol = "BioProject"
  )
```

## Get a list of all of the BioSample metadata

Produced by the pipeline, the biosample-info.tsv files contain all infor from ncbi for each 
BioSample

```{r}
info_files <- list.files(
  path = here("data"),
  pattern = "biosample-info.tsv",
  recursive = TRUE,
  full.names = TRUE
)

# Read all BioSample data into a single data.table
info <- rbindlist(lapply(info_files, fread), fill = TRUE)
```

What are all of the columns?

```{r}
colnames(info)
```

What columns are always present? The first 7 columns are always present.

- accession
- uid
- title
- organization
- taxonomy
- sra
- geo

```{r}
which(lapply(info, anyNA) == FALSE)
```

Can we collapse columns that might indicate the same factor variables?

```{r}
cell_cols <- names(info)[agrepl("cell", names(info), ignore.case = TRUE)]
trt_cols <- names(info)[agrepl("treatment", names(info), ignore.case = TRUE)]

info[, ..trt_cols]
```

