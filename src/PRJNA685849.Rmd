---
title: "PRJNA685849 Analysis"
output:
  html_document:
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 4

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
source("helpers/helpers.R")
```

## Load Libraries

```{r}
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(MultiAssayExperiment))
suppressPackageStartupMessages(library(edgeR))
suppressPackageStartupMessages(library(qsmooth))
```

## Read in MultiAssayExperiment Object

```{r}
mae <- readRDS(here("data", "PRJNA685849", "MultiAssayExperiment.rds"))
```

## Read in gene annotations

```{r}
cds <- readRDS(here("doc", "gencode.v26.annotation.cds.rds"))
```

## Extract RE and Gene Counts as matrices

```{r}
genes <- assay(mae, "gene counts")
repeats <- assay(mae, "RE counts")
```

## Restrict REs to five classes

LINE, SINE, long terminal repeats (LTR), SVA, and DNA transposons

```{r}
repeats <- subset(repeats, grepl(rownames(repeats), pattern = "^LINE\\.|^SINE\\.|^LTR\\.|.*\\.SVA\\..*|^DNA\\."))
```

## Restrict genes to protein coding

```{r}
genes <- subset(genes, rownames(genes) %in% cds$gene_name)
```

## Combine both matrices into a single count matrix

```{r}
# check for consistent colnames
all(colnames(genes) == colnames(repeats))

# bind both matrices into single count matrix
counts <- rbind(genes, repeats)
```

## Sum technical replicates across runs and collapse metadata (if present)

Also has the effect of renaming the rows by the BioSample accession.

```{r, warning=FALSE}
counts <- edgeR::sumTechReps(counts, ID = colData(mae)$BioSample)
colData(mae)$bases <- as.integer(colData(mae)$bases)
metadata <- as.data.table(colData(mae))
metadata <- unique(metadata[, .(BioSample, group)])
setDF(metadata, rownames = metadata$BioSample)
```

## DE pipeline

```{r}
design <- model.matrix(~0 + group, data = metadata)
colnames(design) <- gsub(pattern = "^group", replacement = "", x = colnames(design))
y <- DGEList(counts = counts, samples = metadata)
keep <- filterByExpr(y, design = design)
y <- y[keep,, keep.lib.sizes = FALSE]
qs_norm <- qsmooth(y$counts, group_factor = y$samples$group)
disp <- estimateDisp(y = qsmoothData(qs_norm), design = design, robust = TRUE)
fit <- glmQLFit(y = qsmoothData(qs_norm), dispersion = disp$trended.dispersion, design = design, robust = TRUE)
```

## DE testing

Since there are no 0hr time points for the treatments, treat 4hr as the baseline
as test for genes that respond differently to the drug vs no treatment at each 
time.

```{r}
contrast.matrix <- makeContrasts(
  Cisplatin.50uM_vs_Untreated_4hr = CDDP_50uM_4hr - untreated_4hr,
  Cisplatin.50uM_vs_Untreated_10hr = (CDDP_50uM_10hr - CDDP_50uM_4hr) - (untreated_10hr - untreated_4hr),
  Cisplatin.50uM_vs_Untreated_20hr = (CDDP_50uM_20hr - CDDP_50uM_4hr) - (untreated_20hr - untreated_4hr),
  Hypercin.150nM_irradiation_vs_Untreated_4hr = Hypercin_150nM_irradiation_4hr - untreated_4hr,
  Hypercin.150nM_irradiation_vs_Untreated_10hr = (Hypercin_150nM_irradiation_10hr - Hypercin_150nM_irradiation_4hr) -                                                   (untreated_10hr - untreated_4hr),
  Hypercin.150nM_irradiation_vs_Untreated_20hr = (Hypercin_150nM_irradiation_20hr - Hypercin_150nM_irradiation_4hr) -                                                   (untreated_20hr - untreated_4hr),
  Mitoxantrone.1um_4hr = MTX_1uM_4hr - untreated_4hr,
  Mitoxantrone.1um_10hr = (MTX_1uM_10hr - MTX_1uM_4hr) - (untreated_10hr - untreated_4hr),
  Mitoxantrone.1um_20hr = (MTX_1uM_20hr - MTX_1uM_4hr) - (untreated_20hr - untreated_4hr),

  levels = design
)

# create inputs to map over (titles are same as above)
cons <- colnames(contrast.matrix)
names(cons) <- cons

# set global significance levels (used in all downstream plots/analyses)
fc <- 1.5

# map over and extract results
de_results <- lapply(
  cons, 
  get_de_results2,
  contrast_matrix = contrast.matrix,
  fc = fc,
  glm_fit = fit
)

# extract all results and bind to single df
df <- rbindlist(lapply(de_results, function(x) x[["table"]]), idcol = "contrast")
```

## Calculate normalized counts

```{r}
lcpms <- cpm(qsmoothData(qs_norm), log = TRUE, prior.count = 2)
```

## Save a `SummarizedExperiment` of processed data

Save the:

- Filtered raw counts (gene + RE)
- Normalized counts
- Log counts per million of normalized counts
- Metadata used for DE testing
- Design matrix used for DE testing
- Dispersion estimates for DE testing
- Model fit used in DE testing
- Differential expression results

```{r}
se <- SummarizedExperiment(assays = list("counts" = y$counts,
                                         "qs_norm" = qsmoothData(qs_norm),
                                         "lcpm" = lcpms),
                           colData = metadata,
                           metadata = list("design" = design, 
                                           "contrasts" = contrast.matrix,
                                           "dispersions" = disp,
                                           "fit" = fit,
                                           "de_results" = df))

saveRDS(se, here("results", "PRJNA685849", "rds-files", "se.rds"))
```
