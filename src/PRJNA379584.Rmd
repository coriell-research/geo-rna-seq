---
title: "PRJNA379584 Analysis"
output:
  html_document:
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 4

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
source("helpers/helpers.R")
```

## Load Libraries

```{r}
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(MultiAssayExperiment))
suppressPackageStartupMessages(library(edgeR))
suppressPackageStartupMessages(library(qsmooth))
```

## Read in MultiAssayExperiment Object

```{r}
mae <- readRDS(here("data", "PRJNA379584", "MultiAssayExperiment.rds"))
```

## Read in gene annotations

```{r}
cds <- readRDS(here("doc", "gencode.v26.annotation.cds.rds"))
```

## Extract RE and Gene Counts as matrices

```{r}
genes <- assay(mae, "gene counts")
repeats <- assay(mae, "RE counts")
```

## Restrict REs to five classes

LINE, SINE, long terminal repeats (LTR), SVA, and DNA transposons

```{r}
repeats <- subset(repeats, grepl(rownames(repeats), pattern = "^LINE\\.|^SINE\\.|^LTR\\.|.*\\.SVA\\..*|^DNA\\."))
```

## Restrict genes to protein coding

```{r}
genes <- subset(genes, rownames(genes) %in% cds$gene_name)
```

## Combine both matrices into a single count matrix and add back to MAE

```{r}
# check for consistent colnames
all(colnames(genes) == colnames(repeats))

# bind both matrices into single count matrix
counts <- rbind(genes, repeats)
```

## Sum technical replicates across runs and collapse metadata (if present)

Also has the effect of renaming the rows by the BioSample accession.

```{r, warning=FALSE}
counts <- edgeR::sumTechReps(counts, ID = colData(mae)$BioSample)
colData(mae)$bases <- as.integer(colData(mae)$bases)
metadata <- as.data.table(colData(mae))
metadata <- unique(metadata[, .(BioSample, group, batch)])
setDF(metadata, rownames = metadata$BioSample)
```

## Create new `mae` object from 'counts' matrix

```{r}
mae <- MultiAssayExperiment(
  experiments = list("counts" = counts),
  colData = metadata
  )

# update group type
colData(mae)$group <- factor(colData(mae)$group)
```

## Split MultiAssayExperiment by batch

```{r message=FALSE}
# split by batch
batches <- unique(colData(mae)$batch)
mae_1 <- mae[, colData(mae)$batch == "1"]
mae_2 <- mae[, colData(mae)$batch == "2"]
mae_3 <- mae[, colData(mae)$batch == "3"]
mae_4 <- mae[, colData(mae)$batch == "4"]
mae_5 <- mae[, colData(mae)$batch == "5"]
mae_6 <- mae[, colData(mae)$batch == "6"]
mae_7 <- mae[, colData(mae)$batch == "7"]
mae_8 <- mae[, colData(mae)$batch == "8"]
mae_9 <- mae[, colData(mae)$batch == "9"]
mae_10A <- mae[, colData(mae)$batch == "10A"]
mae_10B <- mae[, colData(mae)$batch == "10B"]
mae_11A <- mae[, colData(mae)$batch == "11A"]
mae_11B <- mae[, colData(mae)$batch == "11B"]
mae_12A <- mae[, colData(mae)$batch == "12A"]
mae_12B <- mae[, colData(mae)$batch == "12B"]
mae_12C <- mae[, colData(mae)$batch == "12C"]

# drop unused factor levels (don't know why this won't work in lapply...)
mae_1$group <- droplevels(mae_1$group)
mae_2$group <- droplevels(mae_2$group)
mae_3$group <- droplevels(mae_3$group)
mae_4$group <- droplevels(mae_4$group)
mae_5$group <- droplevels(mae_5$group)
mae_6$group <- droplevels(mae_6$group)
mae_7$group <- droplevels(mae_7$group)
mae_8$group <- droplevels(mae_8$group)
mae_9$group <- droplevels(mae_9$group)
mae_10A$group <- droplevels(mae_10A$group)
mae_10B$group <- droplevels(mae_10B$group)
mae_11A$group <- droplevels(mae_11A$group)
mae_11B$group <- droplevels(mae_11B$group)
mae_12A$group <- droplevels(mae_12A$group)
mae_12B$group <- droplevels(mae_12B$group)
mae_12C$group <- droplevels(mae_12C$group)

# combine into single list
experiments <- list("1" = mae_1, "2" = mae_2, "3" = mae_3, "4" = mae_4, "5" = mae_5, 
                    "6" = mae_6, "7" = mae_7, "8" = mae_8, "9" = mae_9, "10A" = mae_10A,
                    "10B" = mae_10B, "11A" = mae_11A, "11B" = mae_11B, "12A" = mae_12A, 
                    "12B" = mae_12B, "12C" = mae_12C)
```

## DE pipeline per-batch

Apply the `edgeR` pipeline separately over each batch. Since one of the batches
is generating a full rank error, run each individually.

```{r message=FALSE}
library(edgeR)


pipeline <- function(x) {
  design <- model.matrix(~0 + group, data = colData(x))
  colnames(design) <- gsub(pattern = "^group", replacement = "", x = colnames(design))
  y <- DGEList(counts = assay(x, "counts"),
               samples = colData(x))
  keep <- filterByExpr(y, design = design)
  y <- y[keep,, keep.lib.sizes = FALSE]
  qs_norm <- qsmooth(y$counts, group_factor = y$samples$group)
  disp <- estimateDisp(y = qsmoothData(qs_norm), design = design, robust = TRUE)
  fit <- glmQLFit(y = qsmoothData(qs_norm), dispersion = disp$trended.dispersion, design = design, robust = TRUE)
  list("y" = qsmoothData(qs_norm), "fit" = fit, "design" = design, "raw_counts" = y$counts, "dispersion" = disp, "metadata" = colData(x))
}

pipeline_res <- mclapply(experiments, pipeline, mc.cores = 16)
```

## DE testing

Create a contrast matrix for each batch

```{r}
contrast.matrix.1 <- makeContrasts(
  AZD8055_vs_DMSO_6hr.1 = AZD8055.6 - DMSO.6,
  AZD8055_vs_DMSO_24hr.1 = (AZD8055.24 - AZD8055.6) - (DMSO.24 - DMSO.6),
  Belinostat_vs_DMSO_6hr.1 = Belinostat.6 - DMSO.6,
  Belinostat_vs_DMSO_24hr.1 = (Belinostat.24 - Belinostat.6) - (DMSO.24 - DMSO.6),
  Entinostat_vs_DMSO_6hr.1 = Entinostat.6 - DMSO.6,
  Entinostat_vs_DMSO_24hr.1 = (Entinostat.24 - Entinostat.6) - (DMSO.24 - DMSO.6),
  Imatinib_vs_DMSO_6hr.1 = Imatinib.6 - DMSO.6,
  Imatinib_vs_DMSO_24hr.1 = (Imatinib.24 - Imatinib.6) - (DMSO.24 - DMSO.6),
  MK_2206_vs_DMSO_6hr.1 = MK_2206.6 - DMSO.6,
  MK_2206_vs_DMSO_24hr.1 = (MK_2206.24 - MK_2206.6) - (DMSO.24 - DMSO.6),
  Tivantinib_vs_DMSO_6hr.1 = Tivantinib.6 - DMSO.6,
  Tivantinib_vs_DMSO_24hr.1 = (Tivantinib.24 - Tivantinib.6) - (DMSO.24 - DMSO.6),
  Topotecan_vs_DMSO_6hr.1 = Topotecan.6 - DMSO.6,
  Topotecan_vs_DMSO_24hr.1 = (Topotecan.24 - Topotecan.6) - (DMSO.24 - DMSO.6),
  YK_4_279_vs_DMSO_6hr.1 = YK_4_279.6 - DMSO.6,
  YK_4_279_vs_DMSO_24hr.1 = (YK_4_279.24 - YK_4_279.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["1"]]$design
)

contrast.matrix.2 <- makeContrasts(
  Alisertib_vs_DMSO_6hr.2 = Alisertib.6 - DMSO.6,
  Methylstat_vs_DMSO_24hr.2 = Methylstat.6 - DMSO.6,
  NVP_231_vs_DMSO_6hr.2 = NVP_231.6 - DMSO.6, 
  Obatoclax_vs_DMSO_6hr.2 = Obatoclax.6 - DMSO.6,
  SNX_2112_vs_DMSO_6hr.2 = SNX_2112.6 - DMSO.6,
  Sunitinib_vs_DMSO_6hr.2 = Sunitinib.6 - DMSO.6,
  YM_155_vs_DMSO_6hr.2 = YM_155.6 - DMSO.6,
  
  levels = pipeline_res[["2"]]$design
)

# can't get control for changes over time (trts from different batch)
contrast.matrix.3 <- makeContrasts(
  Alisertib_vs_DMSO_24hr.3 = Alisertib.24 - DMSO.24,
  Methylstat_vs_DMSO_24hr.3 = Methylstat.24 - DMSO.24,
  NVP_231_vs_DMSO_24hr.3 = NVP_231.24 - DMSO.24,
  Obatoclax_vs_DMSO_24hr.3 = Obatoclax.24 - DMSO.24,
  SNX_2112_vs_DMSO_24hr.3 = SNX_2112.24 - DMSO.24,
  Sunitinib_vs_DMSO_24hr.3 = Sunitinib.24 - DMSO.24,
  YM_155_vs_DMSO_24hr.3 = YM_155.24 - DMSO.24,
  
  levels = pipeline_res[["3"]]$design
)

contrast.matrix.4 <- makeContrasts(
  At13387_vs_DMSO_6hr.4 = At13387.6 - DMSO.6,
  At13387_vs_DMSO_24hr.4 = (At13387.24 - At13387.6) - (DMSO.24 - DMSO.6),
  BI_2536_vs_DMSO_6hr.4 = BI_2536.6 - DMSO.6,
  BI_2536_vs_DMSO_24hr.4 = (BI_2536.24 - BI_2536.6) - (DMSO.24 - DMSO.6),
  BMS_754807_vs_DMSO_6hr.4 = BMS_754807.6 - DMSO.6,
  BMS_754807_vs_DMSO_24hr.4  = (BMS_754807.24 - BMS_754807.6) - (DMSO.24 - DMSO.6),
  Bortezomib_vs_DMSO_6hr.4 = Bortezomib.6 - DMSO.6,
  Brefeldin_A_vs_DMSO_6hr.4 = Brefeldin_A.6 - DMSO.6,
  Brefeldin_A_vs_DMSO_24hr.4 = (Brefeldin_A.24 - Brefeldin_A.6) - (DMSO.24 - DMSO.6),
  CD_437_vs_DMSO_6hr.4 = CD_437.6 - DMSO.6,
  CD_437_vs_DMSO_24hr.4 = (CD_437.24 - CD_437.6) - (DMSO.24 - DMSO.6),
  DBeQ_vs_DMSO_6hr.4 = DBeQ.6 - DMSO.6,
  DBeQ_vs_DMSO_24hr.4 = (DBeQ.24 - DBeQ.6) - (DMSO.24 - DMSO.6),
  Fingolimod_vs_DMSO_6hr.4 = Fingolimod.6 - DMSO.6,
  Fingolimod_vs_DMSO_24hr.4 = (Fingolimod.24 - Fingolimod.6) - (DMSO.24 - DMSO.6),
  Flavopiridol_vs_DMSO_6hr.4 = Flavopiridol.6 - DMSO.6,
  Flavopiridol_vs_DMSO_24hr.4 = (Flavopiridol.24 - Flavopiridol.6) - (DMSO.24 - DMSO.6),
  Fluvastatin_vs_DMSO_6hr.4 = Fluvastatin.6 - DMSO.6,
  Fluvastatin_vs_DMSO_24hr.4 = (Fluvastatin.24 - Fluvastatin.6) - (DMSO.24 - DMSO.6),
  Parthenolide_vs_DMSO_6hr.4 = Parthenolide.6 - DMSO.6,
  Parthenolide_vs_DMSO_24hr.4 = (Parthenolide.24 - Parthenolide.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["4"]]$design
)

contrast.matrix.5 <- makeContrasts(
  Foretinib_vs_DMSO_6hr.5 = Foretinib.6 - DMSO.6,
  Foretinib_vs_DMSO_24hr.5  = (Foretinib.24 - Foretinib.6) - (DMSO.24 - DMSO.6),
  GDC_0941_vs_DMSO_6hr.5 = GDC_0941.6 - DMSO.6,
  GDC_0941_vs_DMSO_24hr.5  = (GDC_0941.24 - GDC_0941.6) - (DMSO.24 - DMSO.6),
  GSK1210151A_vs_DMSO_6hr.5 = GSK1210151A.6 - DMSO.6,
  GSK1210151A_vs_DMSO_24hr.5  = (GSK1210151A.24 - GSK1210151A.6) - (DMSO.24 - DMSO.6),
  GSK461364_vs_DMSO_6hr.5 = GSK461364.6 - DMSO.6,
  GSK461364_vs_DMSO_24hr.5 = (GSK461364.24 - GSK461364.6) - (DMSO.24 - DMSO.6),
  JNJ_26854165_vs_DMSO_6hr.5 = JNJ_26854165.6 - DMSO.6,
  JNJ_26854165_vs_DMSO_24hr.5 = (JNJ_26854165.24 - JNJ_26854165.6) - (DMSO.24 - DMSO.6),
  KHS101_vs_DMSO_6hr.5 = KHS101.6 - DMSO.6,
  KHS101_vs_DMSO_24hr.5  = (KHS101.24 - KHS101.6) - (DMSO.24 - DMSO.6),
  KW_2449_vs_DMSO_6hr.5 = KW_2449.6 - DMSO.6,
  KW_2449_vs_DMSO_24hr.5  = (KW_2449.24 - KW_2449.6) - (DMSO.24 - DMSO.6),
  MST_312_vs_DMSO_6hr.5 = MST_312.6 - DMSO.6,
  MST_312_vs_DMSO_24hr.5  = (MST_312.24 - MST_312.6) - (DMSO.24 - DMSO.6),
  Panobinostat_vs_DMSO_6hr.5 = Panobinostat.6 - DMSO.6,
  Panobinostat_vs_DMSO_24hr.5 = (Panobinostat.24 - Panobinostat.6) - (DMSO.24 - DMSO.6),
  Piperlongumine_vs_DMSO_6hr.5 = Piperlongumine.6 - DMSO.6,
  Piperlongumine_vs_DMSO_24hr.5  = (Piperlongumine.24 - Piperlongumine.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["5"]]$design
)

contrast.matrix.6 <- makeContrasts(
  AZD6482_vs_DMSO_6hr.6 = AZD6482.6 - DMSO.6,
  AZD6482_vs_DMSO_24hr.6  = (AZD6482.24 - AZD6482.6) - (DMSO.24 - DMSO.6),
  AZD7762_vs_DMSO_6hr.6 = AZD7762.6 - DMSO.6,
  AZD7762_vs_DMSO_24hr.6  = (AZD7762.24 - AZD7762.6) - (DMSO.24 - DMSO.6),
  Afatinib_vs_DMSO_6hr.6 = Afatinib.6 - DMSO.6,
  Afatinib_vs_DMSO_24hr.6 = (Afatinib.24 - Afatinib.6) - (DMSO.24 - DMSO.6),
  Bafetinib_vs_DMSO_6hr.6 = Bafetinib.6 - DMSO.6,
  Bafetinib_vs_DMSO_24hr.6 = (Bafetinib.24 - Bafetinib.6) - (DMSO.24 - DMSO.6),
  Bardoxolone_methyl_vs_DMSO_6hr.6 = Bardoxolone_methyl.6 - DMSO.6,
  Bardoxolone_methyl_vs_DMSO_24hr.6 = (Bardoxolone_methyl.24 - Bardoxolone_methyl.6) - (DMSO.24 - DMSO.6),
  Bexarotene_vs_DMSO_6hr.6 = Bexarotene.6 - DMSO.6,
  Bexarotene_vs_DMSO_24hr.6 = (Bexarotene.24 - Bexarotene.6) - (DMSO.24 - DMSO.6),
  Brivanib_vs_DMSO_6hr.6 = Brivanib.6 - DMSO.6,
  Brivanib_vs_DMSO_24hr.6 = (Brivanib.24 - Brivanib.6) - (DMSO.24 - DMSO.6),
  CHM_1_vs_DMSO_6hr.6 = CHM_1.6 - DMSO.6,
  CHM_1_vs_DMSO_24hr.6  = (CHM_1.24 - CHM_1.6) - (DMSO.24 - DMSO.6),
  Cerulenin_vs_DMSO_6hr.6 = Cerulenin.6 - DMSO.6,
  Cerulenin_vs_DMSO_24hr.6  = (Cerulenin.24 - Cerulenin.6) - (DMSO.24 - DMSO.6),
  Ciclopirox_vs_DMSO_6hr.6 = Ciclopirox.6 - DMSO.6,
  Ciclopirox_vs_DMSO_24hr.6 = (Ciclopirox.24 - Ciclopirox.6) - (DMSO.24 - DMSO.6),
  x5Zx_7_Oxozeanol_vs_DMSO_6hr.6 = x5Zx_7_Oxozeanol.6 - DMSO.6,
  x5Zx_7_Oxozeanol_vs_DMSO_24hr.6 = (x5Zx_7_Oxozeanol.24 - x5Zx_7_Oxozeanol.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["6"]]$design
)

contrast.matrix.7 <- makeContrasts(
  Crizotinib_vs_DMSO_6hr.7 = Crizotinib.6 - DMSO.6,
  Crizotinib_vs_DMSO_24hr.7  = (Crizotinib.24 - Crizotinib.6) - (DMSO.24 - DMSO.6),
  Dasatinib_vs_DMSO_6hr.7 = Dasatinib.6 - DMSO.6,
  Dasatinib_vs_DMSO_24hr.7  = (Dasatinib.24 - Dasatinib.6) - (DMSO.24 - DMSO.6),
  Dinaciclib_vs_DMSO_6hr.7 = Dinaciclib.6 - DMSO.6,
  Dinaciclib_vs_DMSO_24hr.7  = (Dinaciclib.24 - Dinaciclib.6) - (DMSO.24 - DMSO.6),
  Docetaxel_vs_DMSO_6hr.7 = Docetaxel.6 - DMSO.6,
  Docetaxel_vs_DMSO_24hr.7 = (Docetaxel.24 - Docetaxel.6) - (DMSO.24 - DMSO.6),
  Doxorubicin_vs_DMSO_6hr.7 = Doxorubicin.6 - DMSO.6,
  Doxorubicin_vs_DMSO_24hr.7 = (Doxorubicin.24 - Doxorubicin.6) - (DMSO.24 - DMSO.6),
  Erastin_vs_DMSO_6hr.7 = Erastin.6 - DMSO.6, 
  Erastin_vs_DMSO_24hr.7 = (Erastin.24 - Erastin.6) - (DMSO.24 - DMSO.6),
  GW_405833_vs_DMSO_6hr.7 = GW_405833.6 - DMSO.6, 
  GW_405833_vs_DMSO_24hr.7  = (GW_405833.24 - GW_405833.6) - (DMSO.24 - DMSO.6),
  Gemcitabine_vs_DMSO_6hr.7 = Gemcitabine.6 - DMSO.6,
  Gemcitabine_vs_DMSO_24hr.7 = (Gemcitabine.24 - Gemcitabine.6) - (DMSO.24 - DMSO.6),
  Gossypol_vs_DMSO_6hr.7 = Gossypol.6 - DMSO.6,
  Gossypol_vs_DMSO_24hr.7 = (Gossypol.24 - Gossypol.6) - (DMSO.24 - DMSO.6),
  HMN_214_vs_DMSO_6hr.7 = HMN_214.6 - DMSO.6,
  HMN_214_vs_DMSO_24hr.7  = (HMN_214.24 - HMN_214.6) - (DMSO.24 - DMSO.6),
  Ibrutinib_vs_DMSO_6hr.7 = Ibrutinib.6 - DMSO.6,
  Ibrutinib_vs_DMSO_24hr.7  = (Ibrutinib.24 - Ibrutinib.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["7"]]$design
)

contrast.matrix.8 <- makeContrasts(
  KX2_391_vs_DMSO_6hr.8 = KX2_391.6 - DMSO.6,
  KX2_391_vs_DMSO_24hr.8  = (KX2_391.24 - KX2_391.6) - (DMSO.24 - DMSO.6),
  Linifanib_vs_DMSO_6hr.8 = Linifanib.6 - DMSO.6,
  Linifanib_vs_DMSO_24hr.8  = (Linifanib.24 - Linifanib.6) - (DMSO.24 - DMSO.6),
  Manumycin_A_vs_DMSO_6hr.8 = Manumycin_A.6 - DMSO.6,
  Manumycin_A_vs_DMSO_24hr.8  = (Manumycin_A.24 - Manumycin_A.6) - (DMSO.24 - DMSO.6),
  MG_132_vs_DMSO_6hr.8 = MG_132.6 - DMSO.6,
  MG_132_vs_DMSO_24hr.8  = (MG_132.24 - MG_132.6) - (DMSO.24 - DMSO.6),
  Mithramycin_A_vs_DMSO_6hr.8 = Mithramycin_A.6 - DMSO.6,
  Mithramycin_A_vs_DMSO_24hr.8  = (Mithramycin_A.24 - Mithramycin_A.6) - (DMSO.24 - DMSO.6),
  Mitomycin_C_vs_DMSO_6hr.8 = Mitomycin_C.6 - DMSO.6,
  Mitomycin_C_vs_DMSO_24hr.8  = (Mitomycin_C.24 - Mitomycin_C.6) - (DMSO.24 - DMSO.6),
  MK_1775_vs_DMSO_6hr.8 = MK_1775.6 - DMSO.6,
  MK_1775_vs_DMSO_24hr.8  = (MK_1775.24 - MK_1775.6) - (DMSO.24 - DMSO.6),
  ML210_vs_DMSO_6hr.8 = ML210.6 - DMSO.6,
  ML210_vs_DMSO_24hr.8  = (ML210.24 - ML210.6) - (DMSO.24 - DMSO.6),
  Necrosulfonamide_vs_DMSO_6hr.8 = Necrosulfonamide.6 - DMSO.6, 
  Necrosulfonamide_vs_DMSO_24hr.8  = (Necrosulfonamide.24 - Necrosulfonamide.6) - (DMSO.24 - DMSO.6),
  Neratinib_vs_DMSO_6hr.8 = Neratinib.6 - DMSO.6, 
  Neratinib_vs_DMSO_24hr.8  = (Neratinib.24 - Neratinib.6) - (DMSO.24 - DMSO.6),
  Nutlin_3_vs_DMSO_6hr.8 = Nutlin_3.6 - DMSO.6,
  Nutlin_3_vs_DMSO_24hr.8  = (Nutlin_3.24 - Nutlin_3.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["8"]]$design
)

contrast.matrix.9 <- makeContrasts(
  FK866_vs_DMSO_6hr.9 = FK866.6 - DMSO.6,
  FK866_vs_DMSO_24hr.9  = (FK866.24 - FK866.6) - (DMSO.24 - DMSO.6),
  Istradefylline_vs_DMSO_6hr.9 = Istradefylline.6 - DMSO.6,
  Istradefylline_vs_DMSO_24hr.9  = (Istradefylline.24 - Istradefylline.6) - (DMSO.24 - DMSO.6),
  PAC_1_vs_DMSO_6hr.9 = PAC_1.6 - DMSO.6,
  PAC_1_vs_DMSO_24hr.9  = (PAC_1.24 - PAC_1.6) - (DMSO.24 - DMSO.6),
  Paclitaxel_vs_DMSO_6hr.9 = Paclitaxel.6 - DMSO.6,
  Paclitaxel_vs_DMSO_24hr.9 = (Paclitaxel.24 - Paclitaxel.6) - (DMSO.24 - DMSO.6),
  PF_3758309_vs_DMSO_6hr.9 = PF_3758309.6 - DMSO.6,
  PF_3758309_vs_DMSO_24hr.9  = (PF_3758309.24 - PF_3758309.6) - (DMSO.24 - DMSO.6),
  PHA_665752_vs_DMSO_6hr.9 = PHA_665752.6 - DMSO.6, 
  PHA_665752_vs_DMSO_24hr.9  = (PHA_665752.24 - PHA_665752.6) - (DMSO.24 -  DMSO.6),
  Rigosertib_vs_DMSO_6hr.9 =  Rigosertib.6 - DMSO.6,
  Rigosertib_vs_DMSO_24hr.9  = (Rigosertib.24 - Rigosertib.6) - (DMSO.24 - DMSO.6),
  SB_225002_vs_DMSO_6hr.9 = SB_225002.6 - DMSO.6, 
  SB_225002_vs_DMSO_24hr.9  = (SB_225002.24 - SB_225002.6) - (DMSO.24 - DMSO.6),
  SB_743921_vs_DMSO_6hr.9 = SB_743921.6 - DMSO.6,
  SB_743921_vs_DMSO_24hr.9  = (SB_743921.24 - SB_743921.6) - (DMSO.24 - DMSO.6),
  SCH_529074_vs_DMSO_6hr.9 = SCH_529074.6 - DMSO.6,
  SCH_529074_vs_DMSO_24hr.9  = (SCH_529074.24 - SCH_529074.6) - (DMSO.24 - DMSO.6),
  SCH_79797_vs_DMSO_6hr.9 = SCH_79797.6 - DMSO.6,
  SCH_79797_vs_DMSO_24hr.9  = (SCH_79797.24 - SCH_79797.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["9"]]$design
)

contrast.matrix.10a <- makeContrasts(
  Bortezomib_vs_DMSO_6hr.10A = Bortezomib.6 - DMSO.6,
  Bortezomib_vs_DMSO_24hr.10A  = (Bortezomib.24 - Bortezomib.6) - (DMSO.24 - DMSO.6),
  Erastin_vs_DMSO_6hr.10A = Erastin.6 - DMSO.6, 
  Erastin_vs_DMSO_24hr.10A  = (Erastin.24 - Erastin.6) - (DMSO.24 - DMSO.6),
  Gemcitabine_vs_DMSO_6hr.10A = Gemcitabine.6 -  DMSO.6,
  Gemcitabine_vs_DMSO_24hr.10A  = (Gemcitabine.24 - Gemcitabine.6) - (DMSO.24 - DMSO.6),
  GSK1210151A_vs_DMSO_6hr.10A = GSK1210151A.6 - DMSO.6, 
  GSK1210151A_vs_DMSO_24hr.10A  = (GSK1210151A.24 - GSK1210151A.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["10A"]]$design
)

contrast.matrix.10b <- makeContrasts(
  Bortezomib_vs_DMSO_6hr.10B = Bortezomib.6 - DMSO.6,
  Bortezomib_vs_DMSO_24hr.10B  = (Bortezomib.24 - Bortezomib.6) - (DMSO.24 - DMSO.6),
  GSK461364_vs_DMSO_6hr.10B = GSK461364.6 - DMSO.6, 
  GSK461364_vs_DMSO_24hr.10B  = (GSK461364.24 - GSK461364.6) - (DMSO.24 - DMSO.6),
  Pluripotin_vs_DMSO_6hr.10B = Pluripotin.6 - DMSO.6, 
  Pluripotin_vs_DMSO_24hr.10B = (Pluripotin.24 - Pluripotin.6) - (DMSO.24 - DMSO.6),
  Sorafenib_vs_DMSO_6hr.10B = Sorafenib.6 - DMSO.6,
  Sorafenib_vs_DMSO_24hr.10B  = (Sorafenib.24 - Sorafenib.6) - (DMSO.24 - DMSO.6),
  TW_37_vs_DMSO_6hr.10B = TW_37.6 - DMSO.6,
  TW_37_vs_DMSO_24hr.10B  = (TW_37.24 - TW_37.6) - (DMSO.24 - DMSO.6),
  Vorinostat_vs_DMSO_6hr.10B = Vorinostat.6 - DMSO.6, 
  Vorinostat_vs_DMSO_24hr.10B = (Vorinostat.24 - Vorinostat.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["10B"]]$design
)

contrast.matrix.11a <- makeContrasts(
  Arachidonyl_vs_DMSO_6hr.11A = Arachidonyl.6 - DMSO.6, 
  Arachidonyl_vs_DMSO_24hr.11A = (Arachidonyl.24 - Arachidonyl.6) - (DMSO.24 - DMSO.6), 
  Epigallocatechin_gallate_vs_DMSO_6hr.11A = Epigallocatechin_gallate.6 - DMSO.6, 
  Epigallocatechin_gallate_vs_DMSO_24hr.11A = (Epigallocatechin_gallate.24 - Epigallocatechin_gallate.6) - (DMSO.24 - DMSO.6),
  Parbendazole_vs_DMSO_6hr.11A = Parbendazole.6 - DMSO.6, 
  Parbendazole_vs_DMSO_24hr.11A  = (Parbendazole.24 - Parbendazole.6) - (DMSO.24 - DMSO.6),
  Rosiglitazone_vs_DMSO_6hr.11A = Rosiglitazone.6 - DMSO.6, 
  Rosiglitazone_vs_DMSO_24hr.11A  = (Rosiglitazone.24 - Rosiglitazone.6) - (DMSO.24 - DMSO.6),
  Vincristine_vs_DMSO_6hr.11A = Vincristine.6 -  DMSO.6, 
  Vincristine_vs_DMSO_24hr.11A  = (Vincristine.24 - Vincristine.6) - (DMSO.24 - DMSO.6), 
  Y_27632_vs_DMSO_6hr.11A = Y_27632.6 - DMSO.6, 
  Y_27632_vs_DMSO_24hr.11A = (Y_27632.24 - Y_27632.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["11A"]]$design
)

contrast.matrix.11b <- makeContrasts(
  BIO_vs_DMSO_6hr.11B = BIO.6 - DMSO.6, 
  KU_0063794_vs_DMSO_6hr.11B = KU_0063794.6 - DMSO.6, 
  LY_2183240_vs_DMSO_6hr.11B = LY_2183240.6 - DMSO.6, 
  PF_573228_vs_DMSO_6hr.11B = PF_573228.6 - DMSO.6,

  levels = pipeline_res[["11B"]]$design
)

contrast.matrix.12a <- makeContrasts(
  AUY922_vs_DMSO_6hr.12A = AUY922.6 - DMSO.6, 
  AUY922_vs_DMSO_24hr.12A  = (AUY922.24 - AUY922.6) - (DMSO.24 - DMSO.6), 
  BGJ398_vs_DMSO_6hr.12A = BGJ398.6 - DMSO.6, 
  BGJ398_vs_DMSO_24hr.12A  = (BGJ398.24 - BGJ398.6) - (DMSO.24 - DMSO.6), 
  BIO_vs_DMSO_6hr.12A = BIO.6 - DMSO.6, 
  BIO_vs_DMSO_24hr.12A  = (BIO.24 - BIO.6) - (DMSO.24 - DMSO.6), 
  BKM120_vs_DMSO_6hr.12A = BKM120.6 - DMSO.6, 
  BKM120_vs_DMSO_24hr.12A  = (BKM120.24 - BKM120.6) - (DMSO.24 - DMSO.6), 
  BYL719_vs_DMSO_6hr.12A = BYL719.6 - DMSO.6, 
  BYL719_vs_DMSO_24hr.12A  = (BYL719.24 - BYL719.6) - (DMSO.24 - DMSO.6),
  Ciclopirox_vs_DMSO_24hr.12A = Ciclopirox.24 - DMSO.24, 
  INC280_vs_DMSO_6hr.12A = INC280.6 - DMSO.6,
  INC280_vs_DMSO_24hr.12A  = (INC280.24 - INC280.6) - (DMSO.24 - DMSO.6),
  KU_0063794_vs_DMSO_24hr.12A = KU_0063794.24 - DMSO.24,
  LDK378_vs_DMSO_6hr.12A = LDK378.6 - DMSO.6, 
  LDK378_vs_DMSO_24hr.12A  = (LDK378.24 - LDK378.6) - (DMSO.24 - DMSO.6),
  LEE011_vs_DMSO_6hr.12A = LEE011.6 - DMSO.6, 
  LEE011_vs_DMSO_24hr.12A  = (LEE011.24 - LEE011.6) - (DMSO.24 - DMSO.6),
  LY_2183240_vs_DMSO_24hr.12A = LY_2183240.24 - DMSO.24, 
  Manumycin_A_vs_DMSO_6hr.12A = Manumycin_A.6 - DMSO.6, 
  NIlotinib_vs_DMSO_6hr.12A = NIlotinib.6 - DMSO.6, 
  NIlotinib_vs_DMSO_24hr.12A  = (NIlotinib.24 - NIlotinib.6) - (DMSO.24 - DMSO.6),
  PF_573228_vs_DMSO_24hr.12A  = PF_573228.24 - DMSO.24, 
  Piperlongumine_vs_DMSO_6hr.12A = Piperlongumine.6 - DMSO.6, 
  PKC412_vs_DMSO_6hr.12A = PKC412.6 - DMSO.6, 
  PKC412_vs_DMSO_24hr.12A  = (PKC412.24 - PKC412.6) - (DMSO.24 - DMSO.6),
  Pluripotin_vs_DMSO_24hr.12A = Pluripotin.24 - DMSO.24,
  RAD001_vs_DMSO_6hr.12A = RAD001.6 - DMSO.6, 
  RAD001_vs_DMSO_24hr.12A  = (RAD001.24 - RAD001.6) - (DMSO.24 - DMSO.6), 
  SCH_79797_vs_DMSO_24hr.12A = SCH_79797.24 - DMSO.24,
  SU11274_vs_DMSO_6hr.12A = SU11274.6 - DMSO.6, 
  SU11274_vs_DMSO_24hr.12A  = (SU11274.24 - SU11274.6) - (DMSO.24 - DMSO.6),
  Y_27632_vs_DMSO_6hr.12A = Y_27632.6 - DMSO.6,
  
  levels = pipeline_res[["12A"]]$design
)

contrast.matrix.12b <- makeContrasts(
  CAY10618_in_Methanol_vs_Methanol_6hr.12B = CAY10618_in_Methanol.6 - Methanol.6, 
  CAY10618_in_Methanol_vs_Methanol_24hr.12B = (CAY10618_in_Methanol.24 - CAY10618_in_Methanol.6) - (Methanol.24 - Methanol.6),
  
  levels = pipeline_res[["12B"]]$design
)

contrast.matrix.12c <- makeContrasts(
  Leptomycin_B_in_Ethanol_vs_Ethanol_6hr.12C = Leptomycin_B_in_Ethanol.6 - Ethanol.6, 
  Leptomycin_B_in_Ethanol_vs_Ethanol_24hr.12C = (Leptomycin_B_in_Ethanol.24 - Leptomycin_B_in_Ethanol.6) - (Ethanol.24 - Ethanol.6),
  
  levels = pipeline_res[["12C"]]$design
)

contrast_mats <- list(
  "1" = contrast.matrix.1,
  "2" = contrast.matrix.2,
  "3" = contrast.matrix.3,
  "4" = contrast.matrix.4,
  "5" = contrast.matrix.5,
  "6" = contrast.matrix.6,
  "7" = contrast.matrix.7,
  "8" = contrast.matrix.8,
  "9" = contrast.matrix.9,
  "10A" = contrast.matrix.10a,
  "10B" = contrast.matrix.10b,
  "11A" = contrast.matrix.11a,
  "11B" = contrast.matrix.11b,
  "12A" = contrast.matrix.12a,
  "12B" = contrast.matrix.12b,
  "12C" = contrast.matrix.12c
)
```

Create modified version of get_de_results function that doesn't produce any plots

```{r}
# inner function -- operates on contrast level
get_de_results <- function(contrast_name, glm_fit, contrast_matrix, fc = 1.5) {
  res_df <- coriell::edger_to_df(
    glmTreat(
      glm_fit, 
      contrast = contrast_matrix[, contrast_name],
      lfc = log2(fc)
      )
    )
  
  return(list("table" = res_df))
}

# outer function - operates on batch level
get_batch_results <- function(x) {
  contrasts <- colnames(contrast_mats[[x]])
  names(contrasts) <- contrasts
  
  batch_res <- mclapply(
    X = contrasts,
    FUN = get_de_results,
    glm_fit = pipeline_res[[x]]$fit,
    contrast_matrix = contrast_mats[[x]],
    fc = 1.5,
    mc.cores = 12
  )
  
  res_df <- rbindlist(lapply(batch_res, function(x) x[["table"]]), idcol = "contrast")
  res_df[, batch_id := x]
  
  return(res_df)
}

de_results <- lapply(X = names(pipeline_res), FUN = get_batch_results)
df <- rbindlist(de_results)
df[, batch_id := NULL]
```

## Calculate normalized counts

```{r}
lcpms <- lapply(pipeline_res, function(x) {cpm(x$y, log = TRUE, prior.count = 2)})
```

## Save a `SummarizedExperiment` of processed data

Save the:

- Filtered raw counts (gene + RE)
- Normalized counts
- Log counts per million of normalized counts
- Metadata used for DE testing
- Design matrix used for DE testing
- Dispersion estimates for DE testing
- Model fit used in DE testing
- Differential expression results

```{r}
create_se <- function(res, conmat, logcounts, de) {
  se <- SummarizedExperiment(assays = list("counts" = res[["raw_counts"]],
                                           "qs_norm" = res[["y"]],
                                           "lcpm" = logcounts),
                             colData = res[["metadata"]],
                             metadata = list("design" = res[["design"]],
                                             "contrasts" = conmat,
                                             "fit" = res[["fit"]],
                                             "dispersions" = res[["dispersion"]],
                                             "de_results" = de))
  return(se)
}

ses <- mapply(create_se, res = pipeline_res, conmat = contrast_mats, logcounts = lcpms, de = de_results, SIMPLIFY = FALSE)
invisible(lapply(names(ses), function(x) saveRDS(ses[[x]], here("results", "PRJNA379584", "rds-files", paste0("se-", x, ".rds")))))
```
