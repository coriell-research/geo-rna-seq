---
title: "PRJNA379584 Analysis"
output:
  html_document:
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 4
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

## Read in SummarizedExperiment Object

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(SummarizedExperiment)


se <- readRDS(here("data", "PRJNA379584", "summarized_experiment.rds"))
```

## Read in gene annotations

```{r}
cds <- read_rds(here("doc", "gencode.v26.annotation.cds.rds"))
```

## Filter out RNA REs from counts assay

```{r}
se <- subset(se, !str_detect(rownames(se), "tRNA|snRNA|scRNA|rRNA|srpRNA|Simple_repeat|Low_complexity"))
```

## Split SummarizedExperiment by batch

```{r message=FALSE}
# split by batch
batches <- unique(colData(se)$batch)
se_1 <- se[, colData(se)$batch == "1"]
se_2 <- se[, colData(se)$batch == "2"]
se_3 <- se[, colData(se)$batch == "3"]
se_4 <- se[, colData(se)$batch == "4"]
se_5 <- se[, colData(se)$batch == "5"]
se_6 <- se[, colData(se)$batch == "6"]
se_7 <- se[, colData(se)$batch == "7"]
se_8 <- se[, colData(se)$batch == "8"]
se_9 <- se[, colData(se)$batch == "9"]
se_10A <- se[, colData(se)$batch == "10A"]
se_10B <- se[, colData(se)$batch == "10B"]
se_11A <- se[, colData(se)$batch == "11A"]
se_11B <- se[, colData(se)$batch == "11B"]
se_12A <- se[, colData(se)$batch == "12A"]
se_12B <- se[, colData(se)$batch == "12B"]
se_12C <- se[, colData(se)$batch == "12C"]

# drop unused factor levels (don't know why this won't work in lapply...)
se_1$group <- droplevels(se_1$group)
se_2$group <- droplevels(se_2$group)
se_3$group <- droplevels(se_3$group)
se_4$group <- droplevels(se_4$group)
se_5$group <- droplevels(se_5$group)
se_6$group <- droplevels(se_6$group)
se_7$group <- droplevels(se_7$group)
se_8$group <- droplevels(se_8$group)
se_9$group <- droplevels(se_9$group)
se_10A$group <- droplevels(se_10A$group)
se_10B$group <- droplevels(se_10B$group)
se_11A$group <- droplevels(se_11A$group)
se_11B$group <- droplevels(se_11B$group)
se_12A$group <- droplevels(se_12A$group)
se_12B$group <- droplevels(se_12B$group)
se_12C$group <- droplevels(se_12C$group)

# combine into single list
experiments <- list("1" = se_1, "2" = se_2, "3" = se_3, "4" = se_4, "5" = se_5, 
                    "6" = se_6, "7" = se_7, "8" = se_8, "9" = se_9, "10A" = se_10A,
                    "10B" = se_10B, "11A" = se_11A, "11B" = se_11B, "12A" = se_12A, 
                    "12B" = se_12B, "12C" = se_12C)
```

## DE pipeline per-batch

Apply the `edgeR` pipeline separately over each batch. Since one of the batches
is generating a full rank error, run each individually.

```{r message=FALSE}
library(edgeR)


pipeline <- function(x) {
  design <- model.matrix(~0 + group, data = colData(x))
  colnames(design) <- str_remove(colnames(design), "^group")
  y <- DGEList(counts = assay(x, "counts"),
               samples = colData(x))
  keep <- filterByExpr(y, design = design)
  y <- y[keep,, keep.lib.sizes = FALSE]
  y <- calcNormFactors(y, design = design, method = "TMM")
  y <- estimateDisp(y, design = design, robust = TRUE)
  fit <- glmQLFit(y, design = design, robust = TRUE)
  list("y" = y, "fit" = fit, "design" = design)
}

pipeline_res <- mclapply(experiments, pipeline, mc.cores = 16)
```

## DE testing

Create a contrast matrix for each batch

```{r}
contrast.matrix.1 <- makeContrasts(
  AZD8055.6 = AZD8055.6 - DMSO.6,
  AZD8055.24 = (AZD8055.24 - AZD8055.6) - (DMSO.24 - DMSO.6),
  Belinostat.6 = Belinostat.6 - DMSO.6,
  Belinostat.24 = (Belinostat.24 - Belinostat.6) - (DMSO.24 - DMSO.6),
  Entinostat.6 = Entinostat.6 - DMSO.6,
  Entinostat.24 = (Entinostat.24 - Entinostat.6) - (DMSO.24 - DMSO.6),
  Imatinib.6 = Imatinib.6 - DMSO.6,
  Imatinib.24 = (Imatinib.24 - Imatinib.6) - (DMSO.24 - DMSO.6),
  MK_2206.6 = MK_2206.6 - DMSO.6,
  MK_2206.24 = (MK_2206.24 - MK_2206.6) - (DMSO.24 - DMSO.6),
  Tivantinib.6 = Tivantinib.6 - DMSO.6,
  Tivantinib.24 = (Tivantinib.24 - Tivantinib.6) - (DMSO.24 - DMSO.6),
  Topotecan.6 = Topotecan.6 - DMSO.6,
  Topotecan.24 = (Topotecan.24 - Topotecan.6) - (DMSO.24 - DMSO.6),
  YK_4_279.6 = YK_4_279.6 - DMSO.6,
  YK_4_279.24 = (YK_4_279.24 - YK_4_279.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["1"]]$design
)

contrast.matrix.2 <- makeContrasts(
  Alisertib.6 = Alisertib.6 - DMSO.6,
  Methylstat.6 = Methylstat.6 - DMSO.6,
  NVP_231.6 = NVP_231.6 - DMSO.6, 
  Obatoclax.6 = Obatoclax.6 - DMSO.6,
  SNX_2112.6 = SNX_2112.6 - DMSO.6,
  Sunitinib.6 = Sunitinib.6 - DMSO.6,
  YM_155.6 = YM_155.6 - DMSO.6,
  
  levels = pipeline_res[["2"]]$design
)

# can't get control for changes over time (trts from different batch)
contrast.matrix.3 <- makeContrasts(
  Alisertib.24 = Alisertib.24 - DMSO.24,
  Methylstat.24 = Methylstat.24 - DMSO.24,
  NVP_231.24 = NVP_231.24 - DMSO.24,
  Obatoclax.24 = Obatoclax.24 - DMSO.24,
  SNX_2112.24 = SNX_2112.24 - DMSO.24,
  Sunitinib.24 = Sunitinib.24 - DMSO.24,
  YM_155.24 = YM_155.24 - DMSO.24,
  
  levels = pipeline_res[["3"]]$design
)

contrast.matrix.4 <- makeContrasts(
  At13387.6 = At13387.6 - DMSO.6,
  At13387.24 = (At13387.24 - At13387.6) - (DMSO.24 - DMSO.6),
  BI_2536.6 = BI_2536.6 - DMSO.6,
  BI_2536.24 = (BI_2536.24 - BI_2536.6) - (DMSO.24 - DMSO.6),
  BMS_754807.6 = BMS_754807.6 - DMSO.6,
  BMS_754807.24 = (BMS_754807.24 - BMS_754807.6) - (DMSO.24 - DMSO.6),
  Bortezomib.6 = Bortezomib.6 - DMSO.6,
  Brefeldin_A.6 = Brefeldin_A.6 - DMSO.6,
  Brefeldin_A.24 = (Brefeldin_A.24 - Brefeldin_A.6) - (DMSO.24 - DMSO.6),
  CD_437.6 = CD_437.6 - DMSO.6,
  CD_437.24 = (CD_437.24 - CD_437.6) - (DMSO.24 - DMSO.6),
  DBeQ.6 = DBeQ.6 - DMSO.6,
  DBeQ.24 = (DBeQ.24 - DBeQ.6) - (DMSO.24 - DMSO.6),
  Fingolimod.6 = Fingolimod.6 - DMSO.6,
  Fingolimod.24 = (Fingolimod.24 - Fingolimod.6) - (DMSO.24 - DMSO.6),
  Flavopiridol.6 = Flavopiridol.6 - DMSO.6,
  Flavopiridol.24 = (Flavopiridol.24 - Flavopiridol.6) - (DMSO.24 - DMSO.6),
  Fluvastatin.6 = Fluvastatin.6 - DMSO.6,
  Fluvastatin.24 = (Fluvastatin.24 - Fluvastatin.6) - (DMSO.24 - DMSO.6),
  Parthenolide.6 = Parthenolide.6 - DMSO.6,
  Parthenolide.24 = (Parthenolide.24 - Parthenolide.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["4"]]$design
)

contrast.matrix.5 <- makeContrasts(
  Foretinib.6 = Foretinib.6 - DMSO.6,
  Foretinib.24 = (Foretinib.24 - Foretinib.6) - (DMSO.24 - DMSO.6),
  GDC_0941.6 = GDC_0941.6 - DMSO.6,
  GDC_0941.24 = (GDC_0941.24 - GDC_0941.6) - (DMSO.24 - DMSO.6),
  GSK1210151A.6 = GSK1210151A.6 - DMSO.6,
  GSK1210151A.24 = (GSK1210151A.24 - GSK1210151A.6) - (DMSO.24 - DMSO.6),
  GSK461364.6 = GSK461364.6 - DMSO.6,
  GSK461364.24 = (GSK461364.24 - GSK461364.6) - (DMSO.24 - DMSO.6),
  JNJ_26854165.6 = JNJ_26854165.6 - DMSO.6,
  JNJ_26854165.24 = (JNJ_26854165.24 - JNJ_26854165.6) - (DMSO.24 - DMSO.6),
  KHS101.6 = KHS101.6 - DMSO.6,
  KHS101.24 = (KHS101.24 - KHS101.6) - (DMSO.24 - DMSO.6),
  KW_2449.6 = KW_2449.6 - DMSO.6,
  KW_2449.24 = (KW_2449.24 - KW_2449.6) - (DMSO.24 - DMSO.6),
  MST_312.6 = MST_312.6 - DMSO.6,
  MST_312.24 = (MST_312.24 - MST_312.6) - (DMSO.24 - DMSO.6),
  Panobinostat.6 = Panobinostat.6 - DMSO.6,
  Panobinostat.24 = (Panobinostat.24 - Panobinostat.6) - (DMSO.24 - DMSO.6),
  Piperlongumine.6 = Piperlongumine.6 - DMSO.6,
  Piperlongumine.24 = (Piperlongumine.24 - Piperlongumine.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["5"]]$design
)

contrast.matrix.6 <- makeContrasts(
  AZD6482.6 = AZD6482.6 - DMSO.6,
  AZD6482.24 = (AZD6482.24 - AZD6482.6) - (DMSO.24 - DMSO.6),
  AZD7762.6 = AZD7762.6 - DMSO.6,
  AZD7762.24 = (AZD7762.24 - AZD7762.6) - (DMSO.24 - DMSO.6),
  Afatinib.6 = Afatinib.6 - DMSO.6,
  Afatinib.24 = (Afatinib.24 - Afatinib.6) - (DMSO.24 - DMSO.6),
  Bafetinib.6 = Bafetinib.6 - DMSO.6,
  Bafetinib.24 = (Bafetinib.24 - Bafetinib.6) - (DMSO.24 - DMSO.6),
  Bardoxolone_methyl.6 = Bardoxolone_methyl.6 - DMSO.6,
  Bardoxolone_methyl.24 = (Bardoxolone_methyl.24 - Bardoxolone_methyl.6) - (DMSO.24 - DMSO.6),
  Bexarotene.6 = Bexarotene.6 - DMSO.6,
  Bexarotene.24 = (Bexarotene.24 - Bexarotene.6) - (DMSO.24 - DMSO.6),
  Brivanib.6 = Brivanib.6 - DMSO.6,
  Brivanib.24 = (Brivanib.24 - Brivanib.6) - (DMSO.24 - DMSO.6),
  CHM_1.6 = CHM_1.6 - DMSO.6,
  CHM_1.24 = (CHM_1.24 - CHM_1.6) - (DMSO.24 - DMSO.6),
  Cerulenin.6 = Cerulenin.6 - DMSO.6,
  Cerulenin.24 = (Cerulenin.24 - Cerulenin.6) - (DMSO.24 - DMSO.6),
  Ciclopirox.6 = Ciclopirox.6 - DMSO.6,
  Ciclopirox.24 = (Ciclopirox.24 - Ciclopirox.6) - (DMSO.24 - DMSO.6),
  x5Zx_7_Oxozeanol.6 = x5Zx_7_Oxozeanol.6 - DMSO.6,
  x5Zx_7_Oxozeanol.24 = (x5Zx_7_Oxozeanol.24 - x5Zx_7_Oxozeanol.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["6"]]$design
)

contrast.matrix.7 <- makeContrasts(
  Crizotinib.6 = Crizotinib.6 - DMSO.6,
  Crizotinib.24 = (Crizotinib.24 - Crizotinib.6) - (DMSO.24 - DMSO.6),
  Dasatinib.6 = Dasatinib.6 - DMSO.6,
  Dasatinib.24 = (Dasatinib.24 - Dasatinib.6) - (DMSO.24 - DMSO.6),
  Dinaciclib.6 = Dinaciclib.6 - DMSO.6,
  Dinaciclib.24 = (Dinaciclib.24 - Dinaciclib.6) - (DMSO.24 - DMSO.6),
  Docetaxel.6 = Docetaxel.6 - DMSO.6,
  Docetaxel.24 = (Docetaxel.24 - Docetaxel.6) - (DMSO.24 - DMSO.6),
  Doxorubicin.6 = Doxorubicin.6 - DMSO.6,
  Doxorubicin.24 = (Doxorubicin.24 - Doxorubicin.6) - (DMSO.24 - DMSO.6),
  Erastin.6 = Erastin.6 - DMSO.6, 
  Erastin.24 = (Erastin.24 - Erastin.6) - (DMSO.24 - DMSO.6),
  GW_405833.6 = GW_405833.6 - DMSO.6, 
  GW_405833.24 = (GW_405833.24 - GW_405833.6) - (DMSO.24 - DMSO.6),
  Gemcitabine.6 = Gemcitabine.6 - DMSO.6,
  Gemcitabine.24 = (Gemcitabine.24 - Gemcitabine.6) - (DMSO.24 - DMSO.6),
  Gossypol.6 = Gossypol.6 - DMSO.6,
  Gossypol.24 = (Gossypol.24 - Gossypol.6) - (DMSO.24 - DMSO.6),
  HMN_214.6 = HMN_214.6 - DMSO.6,
  HMN_214.24 = (HMN_214.24 - HMN_214.6) - (DMSO.24 - DMSO.6),
  Ibrutinib.6 = Ibrutinib.6 - DMSO.6,
  Ibrutinib.24 = (Ibrutinib.24 - Ibrutinib.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["7"]]$design
)

contrast.matrix.8 <- makeContrasts(
  KX2_391.6 = KX2_391.6 - DMSO.6,
  KX2_391.24 = (KX2_391.24 - KX2_391.6) - (DMSO.24 - DMSO.6),
  Linifanib.6 = Linifanib.6 - DMSO.6,
  Linifanib.24 = (Linifanib.24 - Linifanib.6) - (DMSO.24 - DMSO.6),
  Manumycin_A.6 = Manumycin_A.6 - DMSO.6,
  Manumycin_A.24 = (Manumycin_A.24 - Manumycin_A.6) - (DMSO.24 - DMSO.6),
  MG_132.6 = MG_132.6 - DMSO.6,
  MG_132.24 = (MG_132.24 - MG_132.6) - (DMSO.24 - DMSO.6),
  Mithramycin_A.6 = Mithramycin_A.6 - DMSO.6,
  Mithramycin_A.24 = (Mithramycin_A.24 - Mithramycin_A.6) - (DMSO.24 - DMSO.6),
  Mitomycin_C.6 = Mitomycin_C.6 - DMSO.6,
  Mitomycin_C.24 = (Mitomycin_C.24 - Mitomycin_C.6) - (DMSO.24 - DMSO.6),
  MK_1775.6 = MK_1775.6 - DMSO.6,
  MK_1775.24 = (MK_1775.24 - MK_1775.6) - (DMSO.24 - DMSO.6),
  ML210.6 = ML210.6 - DMSO.6,
  ML210.24 = (ML210.24 - ML210.6) - (DMSO.24 - DMSO.6),
  Necrosulfonamide.6 = Necrosulfonamide.6 - DMSO.6, 
  Necrosulfonamide.24 = (Necrosulfonamide.24 - Necrosulfonamide.6) - (DMSO.24 - DMSO.6),
  Neratinib.6 = Neratinib.6 - DMSO.6, 
  Neratinib.24 = (Neratinib.24 - Neratinib.6) - (DMSO.24 - DMSO.6),
  Nutlin_3.6 = Nutlin_3.6 - DMSO.6,
  Nutlin_3.24 = (Nutlin_3.24 - Nutlin_3.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["8"]]$design
)

contrast.matrix.9 <- makeContrasts(
  FK866.6 = FK866.6 - DMSO.6,
  FK866.24 = (FK866.24 - FK866.6) - (DMSO.24 - DMSO.6),
  Istradefylline.6 = Istradefylline.6 - DMSO.6,
  Istradefylline.24 = (Istradefylline.24 - Istradefylline.6) - (DMSO.24 - DMSO.6),
  PAC_1.6 = PAC_1.6 - DMSO.6,
  PAC_1.24 = (PAC_1.24 - PAC_1.6) - (DMSO.24 - DMSO.6),
  Paclitaxel.6 = Paclitaxel.6 - DMSO.6,
  Paclitaxel.24 = (Paclitaxel.24 - Paclitaxel.6) - (DMSO.24 - DMSO.6),
  PF_3758309.6 = PF_3758309.6 - DMSO.6,
  PF_3758309.24 = (PF_3758309.24 - PF_3758309.6) - (DMSO.24 - DMSO.6),
  PHA_665752.6 = PHA_665752.6 - DMSO.6, 
  PHA_665752.24 = (PHA_665752.24 - PHA_665752.6) - (DMSO.24 -  DMSO.6),
  Rigosertib.6 =  Rigosertib.6 - DMSO.6,
  Rigosertib.24 = (Rigosertib.24 - Rigosertib.6) - (DMSO.24 - DMSO.6),
  SB_225002.6 = SB_225002.6 - DMSO.6, 
  SB_225002.24 = (SB_225002.24 - SB_225002.6) - (DMSO.24 - DMSO.6),
  SB_743921.6 = SB_743921.6 - DMSO.6,
  SB_743921.24 = (SB_743921.24 - SB_743921.6) - (DMSO.24 - DMSO.6),
  SCH_529074.6 = SCH_529074.6 - DMSO.6,
  SCH_529074.24 = (SCH_529074.24 - SCH_529074.6) - (DMSO.24 - DMSO.6),
  SCH_79797.6 = SCH_79797.6 - DMSO.6,
  SCH_79797.24 = (SCH_79797.24 - SCH_79797.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["9"]]$design
)

contrast.matrix.10a <- makeContrasts(
  Bortezomib.6 = Bortezomib.6 - DMSO.6,
  Bortezomib.24 = (Bortezomib.24 - Bortezomib.6) - (DMSO.24 - DMSO.6),
  Erastin.6 = Erastin.6 - DMSO.6, 
  Erastin.24 = (Erastin.24 - Erastin.6) - (DMSO.24 - DMSO.6),
  Gemcitabine.6 = Gemcitabine.6 -  DMSO.6,
  Gemcitabine.24 = (Gemcitabine.24 - Gemcitabine.6) - (DMSO.24 - DMSO.6),
  GSK1210151A.6 = GSK1210151A.6 - DMSO.6, 
  GSK1210151A.24 = (GSK1210151A.24 - GSK1210151A.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["10A"]]$design
)

contrast.matrix.10b <- makeContrasts(
  Bortezomib.6 = Bortezomib.6 - DMSO.6,
  Bortezomib.24 = (Bortezomib.24 - Bortezomib.6) - (DMSO.24 - DMSO.6),
  GSK461364.6 = GSK461364.6 - DMSO.6, 
  GSK461364.24 = (GSK461364.24 - GSK461364.6) - (DMSO.24 - DMSO.6),
  Pluripotin.6 = Pluripotin.6 - DMSO.6, 
  Pluripotin.24 = (Pluripotin.24 - Pluripotin.6) - (DMSO.24 - DMSO.6),
  Sorafenib.6 = Sorafenib.6 - DMSO.6,
  Sorafenib.24 = (Sorafenib.24 - Sorafenib.6) - (DMSO.24 - DMSO.6),
  TW_37.6 = TW_37.6 - DMSO.6,
  TW_37.24 = (TW_37.24 - TW_37.6) - (DMSO.24 - DMSO.6),
  Vorinostat.6 = Vorinostat.6 - DMSO.6, 
  Vorinostat.24 = (Vorinostat.24 - Vorinostat.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["10B"]]$design
)

contrast.matrix.11a <- makeContrasts(
  Arachidonyl.6 = Arachidonyl.6 - DMSO.6, 
  Arachidonyl.24 = (Arachidonyl.24 - Arachidonyl.6) - (DMSO.24 - DMSO.6), 
  Epigallocatechin_gallate.6 = Epigallocatechin_gallate.6 - DMSO.6, 
  Epigallocatechin_gallate.24 = (Epigallocatechin_gallate.24 - Epigallocatechin_gallate.6) - (DMSO.24 - DMSO.6),
  Parbendazole.6 = Parbendazole.6 - DMSO.6, 
  Parbendazole.24 = (Parbendazole.24 - Parbendazole.6) - (DMSO.24 - DMSO.6),
  Rosiglitazone.6 = Rosiglitazone.6 - DMSO.6, 
  Rosiglitazone.24 = (Rosiglitazone.24 - Rosiglitazone.6) - (DMSO.24 - DMSO.6),
  Vincristine.6 = Vincristine.6 -  DMSO.6, 
  Vincristine.24 = (Vincristine.24 - Vincristine.6) - (DMSO.24 - DMSO.6), 
  Y_27632.6 = Y_27632.6 - DMSO.6, 
  Y_27632.24 = (Y_27632.24 - Y_27632.6) - (DMSO.24 - DMSO.6),
  
  levels = pipeline_res[["11A"]]$design
)

contrast.matrix.11b <- makeContrasts(
  BIO.6 = BIO.6 - DMSO.6, 
  KU_0063794.6 = KU_0063794.6 - DMSO.6, 
  LY_2183240.6 = LY_2183240.6 - DMSO.6, 
  PF_573228.6 = PF_573228.6 - DMSO.6,
  
  levels = pipeline_res[["11B"]]$design
)

contrast.matrix.12a <- makeContrasts(
  AUY922.6 = AUY922.6 - DMSO.6, 
  AUY922.24 = (AUY922.24 - AUY922.6) - (DMSO.24 - DMSO.6), 
  BGJ398.6 = BGJ398.6 - DMSO.6, 
  BGJ398.24 = (BGJ398.24 - BGJ398.6) - (DMSO.24 - DMSO.6), 
  BIO.6 = BIO.6 - DMSO.6, 
  BIO.24 = (BIO.24 - BIO.6) - (DMSO.24 - DMSO.6), 
  BKM120.6 = BKM120.6 - DMSO.6, 
  BKM120.24 = (BKM120.24 - BKM120.6) - (DMSO.24 - DMSO.6), 
  BYL719.6 = BYL719.6 - DMSO.6, 
  BYL719.24 = (BYL719.24 - BYL719.6) - (DMSO.24 - DMSO.6),
  Ciclopirox.24 = Ciclopirox.24 - DMSO.24, 
  INC280.6 = INC280.6 - DMSO.6,
  INC280.24 = (INC280.24 - INC280.6) - (DMSO.24 - DMSO.6),
  KU_0063794.24 = KU_0063794.24 - DMSO.24,
  LDK378.6 = LDK378.6 - DMSO.6, 
  LDK378.24 = (LDK378.24 - LDK378.6) - (DMSO.24 - DMSO.6),
  LEE011.6 = LEE011.6 - DMSO.6, 
  LEE011.24 = (LEE011.24 - LEE011.6) - (DMSO.24 - DMSO.6),
  LY_2183240.24 = LY_2183240.24 - DMSO.24, 
  Manumycin_A.6 = Manumycin_A.6 - DMSO.6, 
  NIlotinib.6 = NIlotinib.6 - DMSO.6, 
  NIlotinib.24 = (NIlotinib.24 - NIlotinib.6) - (DMSO.24 - DMSO.6),
  PF_573228.24 = PF_573228.24 - DMSO.24, 
  Piperlongumine.6 = Piperlongumine.6 - DMSO.6, 
  PKC412.6 = PKC412.6 - DMSO.6, 
  PKC412.24 = (PKC412.24 - PKC412.6) - (DMSO.24 - DMSO.6),
  Pluripotin.24 = Pluripotin.24 - DMSO.24,
  RAD001.6 = RAD001.6 - DMSO.6, 
  RAD001.24 = (RAD001.24 - RAD001.6) - (DMSO.24 - DMSO.6), 
  SCH_79797.24 = SCH_79797.24 - DMSO.24,
  SU11274.6 = SU11274.6 - DMSO.6, 
  SU11274.24 = (SU11274.24 - SU11274.6) - (DMSO.24 - DMSO.6),
  Y_27632.6 = Y_27632.6 - DMSO.6,
  
  levels = pipeline_res[["12A"]]$design
)

contrast.matrix.12b <- makeContrasts(
  CAY10618_in_Methanol.6 = CAY10618_in_Methanol.6 - Methanol.6, 
  CAY10618_in_Methanol.24 = (CAY10618_in_Methanol.24 - CAY10618_in_Methanol.6) - (Methanol.24 - Methanol.6),
  
  levels = pipeline_res[["12B"]]$design
)

contrast.matrix.12c <- makeContrasts(
  Leptomycin_B_in_Ethanol.6 = Leptomycin_B_in_Ethanol.6 - Ethanol.6, 
  Leptomycin_B_in_Ethanol.24 = (Leptomycin_B_in_Ethanol.24 - Leptomycin_B_in_Ethanol.6) - (Ethanol.24 - Ethanol.6),
  
  levels = pipeline_res[["12C"]]$design
)

contrast_mats <- list(
  "1" = contrast.matrix.1,
  "2" = contrast.matrix.2,
  "3" = contrast.matrix.3,
  "4" = contrast.matrix.4,
  "5" = contrast.matrix.5,
  "6" = contrast.matrix.6,
  "7" = contrast.matrix.7,
  "8" = contrast.matrix.8,
  "9" = contrast.matrix.9,
  "10A" = contrast.matrix.10a,
  "10B" = contrast.matrix.10b,
  "11A" = contrast.matrix.11a,
  "11B" = contrast.matrix.11b,
  "12A" = contrast.matrix.12a,
  "12B" = contrast.matrix.12b,
  "12C" = contrast.matrix.12c
)
```

Create modified version of get_de_results function that doesn't produce any plots
and displays the execution time of each step. To be run in R console session on
tmux.

```{r}
# inner function -- operates on contrast level
get_de_results <- function(contrast_name, glm_fit, contrast_matrix, fc = 1.5) {
  res_df <- glmTreat(
    glm_fit, 
    contrast = contrast_matrix[, contrast_name], 
    lfc = log2(fc)
    ) %>% coriell::edger_to_df()
  
  list("table" = res_df)
}

# outer function - operates on batch level
get_batch_results <- function(x) {
  contrasts <- colnames(contrast_mats[[x]])
  names(contrasts) <- contrasts
  
  batch_res <- mclapply(
    X = contrasts,
    FUN = get_de_results,
    glm_fit = pipeline_res[[x]]$fit,
    contrast_matrix = contrast_mats[[x]],
    fc = 1.5,
    mc.cores = 12
  )
  
  res_df <- map(batch_res, pluck, "table") %>% 
    bind_rows(.id = "contrast") %>% 
    mutate(batch_id = x)
  
  res_df
}

de_results <- lapply(X = names(pipeline_res), FUN = get_batch_results)
df <- bind_rows(de_results) %>% 
  mutate(contrast = str_c(contrast, batch_id, sep = ".")) %>% 
  select(-batch_id)
```

## Write results out

```{r}
# split DE results into gene and RE results and write out
dge <- df %>% 
  filter(feature_id %in% cds$gene_name) %>% 
  write_tsv(here("results", "PRJNA379584", "data-files", "dge.tsv"))

dre <- df %>% 
  filter(!feature_id %in% cds$gene_name) %>% 
  write_tsv(here("results", "PRJNA379584", "data-files", "dre.tsv"))
```

## Calculate normalized counts

```{r}
lcpms <- lapply(pipeline_res, function(x) {cpm(x$y, log = TRUE, prior.count = 2)})
lcpms.gene <- lapply(lcpms, function(x) {subset(x, rownames(x) %in% cds$gene_name)})
lcpms.re <- lapply(lcpms, function(x) {subset(x, !rownames(x) %in% cds$gene_name)})

# Write normalized counts out
for (batch in names(lcpms)) {
  write_rds(lcpms.gene[[batch]], here("results", "PRJNA379584", "rds-files", paste0(batch, "-gene-lcpms.rds")))
  write_rds(lcpms.re[[batch]], here("results", "PRJNA379584", "rds-files", paste0(batch, "-re-lcpms.rds")))
}
```
